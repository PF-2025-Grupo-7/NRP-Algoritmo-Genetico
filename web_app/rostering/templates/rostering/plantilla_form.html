{% extends 'base.html' %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">{{ titulo }}</h1>
            <p class="text-muted fs-5 mb-0">Gestión de plantillas de demanda</p>
        </div>
    </div>

    <div class="card border-0" style="border-radius: 14px;">
        <div class="card-body p-4 p-lg-5">
                            <form method="post" id="form-plantilla" novalidate>
                            {% csrf_token %}

                            {% if form.nombre.errors %}
                                <div id="form-warning" class="field-error">
                                    <i class="bi bi-exclamation-circle"></i>
                                    <span id="form-warning-text">{{ form.nombre.errors|join:" " }}</span>
                                </div>
                            {% else %}
                                <div id="form-warning" class="field-error d-none">
                                    <i class="bi bi-exclamation-circle"></i>
                                    <span id="form-warning-text"></span>
                                </div>
                            {% endif %}

                            {% if form.non_field_errors %}
                                <div id="server-errors" class="field-error mb-3">
                                    <i class="bi bi-exclamation-circle"></i>
                                    <span>{{ form.non_field_errors|join:", " }}</span>
                                </div>
                            {% endif %}

                            {% for field in form %}
                                <div class="mb-4">
                                    {% if field.name == 'especialidad' %}
                                        <label class="form-label fw-bold" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="required-asterisk" aria-hidden="true">*</span>{% endif %}</label>
                                        {% if field.field.disabled %}
                                            <div class="custom-select-wrapper">
                                                <div class="custom-dropdown">
                                                    <div class="custom-dropdown-header disabled">{{ form.instance.get_especialidad_display }}</div>
                                                </div>
                                            </div>
                                            <input type="hidden" name="especialidad" value="{{ field.value }}">
                                        {% else %}
                                            <div class="custom-select-wrapper">
                                                <select class="form-select d-none" id="{{ field.id_for_label }}" name="especialidad">
                                                    <option value="" data-label=""></option>
                                                    {% for value,label in field.field.choices %}
                                                        {% if value != '' %}
                                                            <option value="{{ value }}" data-label="{{ label }}" {% if field.value == value|stringformat:'s' %}selected{% endif %}>{{ label }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <div class="custom-dropdown">
                                                    <div class="custom-dropdown-header" tabindex="0" data-placeholder="Seleccioná una especialidad">Seleccioná una especialidad</div>
                                                    <div class="custom-dropdown-menu">
                                                        {% for value,label in field.field.choices %}
                                                            {% if value != '' %}
                                                                <div class="custom-option" data-value="{{ value }}">{{ label }}</div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if field.help_text %}
                                            <div class="form-text text-muted small fst-italic">{{ field.help_text|safe }}</div>
                                        {% endif %}
                                    {% else %}
                                        {% if field.name == 'descripcion' %}
                                            <label class="form-label fw-bold">Descripción{% if field.field.required %}<span class="required-asterisk" aria-hidden="true">*</span>{% endif %}</label>
                                        {% else %}
                                            <label class="form-label fw-bold">{{ field.label }}{% if field.field.required %}<span class="required-asterisk" aria-hidden="true">*</span>{% endif %}</label>
                                        {% endif %}
                                        {{ field }}
                                        {% if field.help_text and field.name != 'nombre' %}
                                            <div class="form-text text-muted small fst-italic">{{ field.help_text|safe }}</div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'plantilla_list' %}" class="btn btn-outline-secondary me-md-2 fw-bold px-4">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary fw-bold px-4">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Forzar estilo a los inputs generados por Django */
    input[type="text"], textarea, select {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        appearance: none;
        border-radius: 0.5rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Replicar estilos de otros formularios */
    .form-control, .form-select {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: #ffffff;
        color: #2f3e4c;
    }
    .form-select.d-none { display: none !important; }
    .form-control::placeholder { color: #adb5bd; font-style: italic; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); background-color: #f8fbff; outline: none; }

    /* Custom select styles (match empleado/nodisponibilidad) */
    .custom-select-wrapper { position: relative; display: inline-block; width: 100%; }
    .custom-dropdown { position: relative; pointer-events: auto; }
    .custom-dropdown-header {
        height: 46px; box-sizing: border-box; border-radius: 8px; border: 1px solid #e0e5ec; background-color: #ffffff;
        padding: 12px 16px; font-size: 0.95rem; line-height: 1; color: #495057; display: inline-flex; align-items: center; width: 100%;
        transition: all 0.2s ease; cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; pointer-events: auto;
    }
    .custom-dropdown-header.is-invalid { border-color: #c41c3b !important; color: #c41c3b !important; box-shadow: 0 0 0 0.15rem rgba(196,28,59,0.15); }
    .custom-dropdown-header:hover { background-color: #f5f7fb; }
    .custom-dropdown-header.disabled{ opacity:0.6; cursor:not-allowed; pointer-events:none; }
    .custom-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background-color: #ffffff; border: none; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); border-radius: 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; pointer-events: none; z-index: 100; margin-top: 0; padding: 0; }
    .custom-dropdown.open .custom-dropdown-menu { max-height: 300px; pointer-events: auto; opacity: 1; margin-top: 0.5rem; padding: 0.5rem 0; }
    .custom-option { padding: 0.5rem 1.2rem; color: #495057; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; border-bottom: none; font-weight: 500; }
    .custom-option:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; padding-left: 1.4rem; }

    /* Warnings estilos */
    .field-error { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 1rem; color: #c41c3b; font-size: 0.95rem; font-weight: 500; }
    .field-error i { font-size: 1rem; }
    .required-asterisk { color: #dc3545; margin-left: 0.25rem; font-weight: 700; }

    /* Botones */
    .btn { border-radius: 8px; font-size: 0.95rem; padding: 0.625rem 1.25rem; transition: all 0.3s ease; font-weight: 600; letter-spacing: 0.2px; }
    .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
    .btn-primary:hover { background-color: #0b5ed7; border-color: #0b5ed7; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3); }
</style>
{% block extra_js %}
<script>
    // setupCustomDropdown copied from empleado_form for consistency
    function setupCustomDropdown(wrapper) {
        const nativeSelect = wrapper.querySelector('.form-select');
        const header = wrapper.querySelector('.custom-dropdown-header');
        const dropdown = wrapper.querySelector('.custom-dropdown');
        const menu = wrapper.querySelector('.custom-dropdown-menu');
        if (!header || !dropdown || !menu || !nativeSelect) return;

        function updateHeaderFromSelect() {
            const val = nativeSelect.value;
            let found = null;
            for (let i = 0; i < nativeSelect.options.length; i++) {
                const opt = nativeSelect.options[i];
                if (opt.value === val) { found = opt; break; }
            }
            if (found && found.value !== '') {
                // Prefer explicit data-label if present (safer across browsers/encodings)
                const lbl = found.getAttribute('data-label') || found.textContent || found.innerText;
                header.textContent = lbl;
            } else {
                const placeholder = header.getAttribute('data-placeholder');
                header.textContent = placeholder || '';
            }
        }

        updateHeaderFromSelect();

        if (nativeSelect.disabled) {
            header.style.cursor = 'not-allowed';
            header.style.opacity = '0.6';
            header.style.backgroundColor = '#f5f5f5';
            return;
        }

        header.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const isOpen = dropdown.classList.contains('open');
            if (!isOpen) { if (window.closeAllDropdowns) window.closeAllDropdowns(dropdown); dropdown.classList.add('open'); } else { dropdown.classList.remove('open'); }
        };

        menu.querySelectorAll('.custom-option').forEach((option) => {
            option.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (nativeSelect.disabled) return;
                const value = option.getAttribute('data-value');
                nativeSelect.value = value;
                dropdown.classList.remove('open');
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            };
        });

        // Ensure header updates whenever the native select value changes
        nativeSelect.addEventListener('change', function() {
            updateHeaderFromSelect();
        });

        document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) dropdown.classList.remove('open'); });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form-plantilla');
        const serverErrors = document.getElementById('server-errors');
        document.querySelectorAll('.custom-select-wrapper').forEach(setupCustomDropdown);

        if (!form) return;
        form.addEventListener('submit', function(e) {
            // Minimal validation: ensure required fields are present
            const warningDiv = document.getElementById('form-warning');
            const warningText = document.getElementById('form-warning-text');
            if (warningDiv) warningDiv.classList.add('d-none');
            if (serverErrors) serverErrors.classList.add('d-none');

            const requiredFields = [];
            // Nombre
            const nombre = form.querySelector('[name="nombre"]');
            if (nombre) requiredFields.push({ field: nombre, name: 'Nombre' });
            // Especialidad
            const esp = form.querySelector('[name="especialidad"]');
            if (esp) requiredFields.push({ field: esp, name: 'Especialidad' });

            const empty = requiredFields.filter(item => !item.field.value || item.field.value.trim() === '');
            if (empty.length > 0) {
                e.preventDefault();
                if (warningText) warningText.textContent = 'Por favor, completá todos los campos obligatorios (*)';
                if (warningDiv) warningDiv.classList.remove('d-none');
                empty.forEach(function(item) {
                    item.field.classList.add('is-invalid');
                    item.field.addEventListener('input', function handler() { item.field.classList.remove('is-invalid'); item.field.removeEventListener('input', handler); });
                    if (item.field.classList.contains('form-select')) {
                        var wrapper = item.field.closest('.custom-select-wrapper');
                        if (wrapper) {
                            var header = wrapper.querySelector('.custom-dropdown-header');
                            if (header) {
                                header.classList.add('is-invalid');
                                item.field.addEventListener('change', function handler2() { header.classList.remove('is-invalid'); item.field.removeEventListener('change', handler2); });
                            }
                        }
                    }
                });
                return;
            }
        });
    });
</script>
{% endblock %}
{% endblock %}