{% extends "base.html" %}

{% block title %}Generador de Turnos{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 text-center">
        <h2 class="mb-4">âš¡ Generador de PlanificaciÃ³n</h2>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body text-start">
                <h5 class="card-title text-muted mb-3">ConfiguraciÃ³n del Escenario</h5>
                
                <form id="form-generador">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Fecha Inicio</label>
                            <input type="date" id="fecha_inicio" class="form-control" value="2025-11-01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha Fin</label>
                            <input type="date" id="fecha_fin" class="form-control" value="2025-11-30">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Especialidad</label>
                            <select id="especialidad" class="form-select">
                                <option value="MEDICO">MÃ©dicos (Turnos 12hs)</option>
                                <option value="ENFERMERO">Enfermeros (Turnos 8hs)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-primary btn-lg" onclick="iniciarGeneracion()">
                            ðŸš€ Ejecutar Algoritmo GenÃ©tico
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="resultado-container" class="alert alert-info d-none">
            <h4>Estado: <span id="estado-badge" class="badge bg-warning">En Proceso...</span></h4>
            <p id="mensaje-estado">El motor estÃ¡ optimizando los turnos...</p>
        </div>

        <hr class="my-5">

        <div class="d-flex justify-content-center">
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger px-5">
                    ðŸšª Cerrar SesiÃ³n y Salir
                </button>
            </form>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Script simple para conectar con tu API (views.py)
    async function iniciarGeneracion() {
        const btn = document.querySelector('button[onclick="iniciarGeneracion()"]');
        const container = document.getElementById('resultado-container');
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');

        // Datos del form
        const payload = {
            fecha_inicio: document.getElementById('fecha_inicio').value,
            fecha_fin: document.getElementById('fecha_fin').value,
            especialidad: document.getElementById('especialidad').value
        };

        // UI Loading
        btn.disabled = true;
        btn.innerText = "â³ Iniciando...";
        container.classList.remove('d-none');

        try {
            // 1. Llamar a Django -> API Docker
            const response = await fetch('/api/planificar/iniciar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Importante para POST en Django
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                msg.innerText = `Job ID: ${data.job_id}. Esperando resultados...`;
                btn.innerText = "ðŸ”„ Procesando...";
                
                // 2. Polling (Consultar estado cada 2 segundos)
                pollEstado(data.job_id);
            } else {
                alert("Error: " + data.error);
                btn.disabled = false;
            }

        } catch (error) {
            console.error(error);
            alert("Error de conexiÃ³n");
            btn.disabled = false;
        }
    }

    async function pollEstado(jobId) {
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');
        const btn = document.querySelector('button[onclick="iniciarGeneracion()"]');

        const intervalo = setInterval(async () => {
            const res = await fetch(`/api/planificar/estado/${jobId}/`);
            const data = await res.json();

            if (data.status === 'completed') {
                clearInterval(intervalo);
                badge.className = 'badge bg-success';
                badge.innerText = 'Â¡Terminado!';
                msg.innerHTML = `<strong>Fitness:</strong> ${data.fitness} <br> Cronograma guardado ID: ${data.cronograma_id}`;
                btn.disabled = false;
                btn.innerText = "ðŸš€ Ejecutar de Nuevo";
                
                // Opcional: Redirigir a la vista de detalle
                // window.location.href = `/cronograma/${data.cronograma_id}/`;
            } else if (data.status === 'failed' || data.status === 'error') {
                clearInterval(intervalo);
                badge.className = 'badge bg-danger';
                badge.innerText = 'Error';
                msg.innerText = data.error;
                btn.disabled = false;
            }
            // Si es 'running', sigue el loop
        }, 2000);
    }
</script>
{% endblock %}