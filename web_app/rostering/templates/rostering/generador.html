{% extends "base.html" %}

{% block title %}Generador de Turnos{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 text-center">
        <h2 class="mb-4">‚ö° Generador de Planificaci√≥n</h2>
        
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-light text-start">
                <h5 class="mb-0 text-muted"><i class="bi bi-sliders"></i> Configuraci√≥n del Escenario</h5>
            </div>
            <div class="card-body text-start p-4">
                <form id="form-generador">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Inicio</label>
                            <input type="date" id="fecha_inicio" class="form-control" value="2025-11-01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Fin</label>
                            <input type="date" id="fecha_fin" class="form-control" value="2025-11-30">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Especialidad</label>
                            <select id="especialidad" class="form-select" onchange="cargarPlantillas()">
                                <option value="MEDICO">M√©dicos (Turnos 12hs)</option>
                                <option value="ENFERMERO">Enfermeros (Turnos 8hs)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Plantilla de Demanda</label>
                            <select id="plantilla" class="form-select" required>
                                <option value="" disabled selected>-- Cargando... --</option>
                            </select>
                            <div class="form-text text-muted small">Define cu√°nta gente se necesita por turno.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" id="btn-accion" class="btn btn-primary btn-lg" onclick="iniciarGeneracion()">
                            üöÄ Ejecutar Algoritmo Gen√©tico
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="resultado-container" class="alert alert-secondary d-none text-center shadow-sm">
            <h4 class="mt-2">Estado: <span id="estado-badge" class="badge bg-secondary">Iniciando...</span></h4>
            <div id="loading-spinner" class="my-3 d-none">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            </div>
            <p id="mensaje-estado" class="fs-5 text-muted">Preparando motor de optimizaci√≥n...</p>
        </div>

        <hr class="my-5">
        <div class="d-flex justify-content-center">
            <a href="{% url 'cronograma_list' %}" class="btn btn-link text-muted text-decoration-none">
                <i class="bi bi-arrow-left"></i> Ir al listado de planificaciones
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    const selectEspecialidad = document.getElementById('especialidad');
    const selectPlantilla = document.getElementById('plantilla');

    // 3. FUNCI√ìN PARA CARGAR PLANTILLAS DESDE LA API
    async function cargarPlantillas() {
        const especialidad = selectEspecialidad.value;
        selectPlantilla.innerHTML = '<option value="" disabled selected>Cargando...</option>';
        selectPlantilla.disabled = true;

        try {
            const res = await fetch(`/api/plantillas/?especialidad=${especialidad}`);
            const data = await res.json();

            selectPlantilla.innerHTML = ''; // Limpiar
            
            if (data.plantillas.length === 0) {
                const opt = document.createElement('option');
                opt.text = "‚ö†Ô∏è No hay plantillas creadas para esta especialidad";
                selectPlantilla.add(opt);
            } else {
                data.plantillas.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = p.nombre;
                    selectPlantilla.add(opt);
                });
                selectPlantilla.disabled = false;
            }
        } catch (error) {
            console.error("Error cargando plantillas:", error);
            selectPlantilla.innerHTML = '<option>Error al cargar</option>';
        }
    }

    // Cargar plantillas al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', cargarPlantillas);


    // 4. ACTUALIZAR LA FUNCI√ìN DE INICIO PARA VALIDAR FECHAS (FIX L√çMITE 31 D√çAS)
    async function iniciarGeneracion() {
        const btn = document.getElementById('btn-accion');
        const container = document.getElementById('resultado-container');
        const badge = document.getElementById('estado-badge');
        const spinner = document.getElementById('loading-spinner');
        const msg = document.getElementById('mensaje-estado');

        // Validar que haya plantilla seleccionada
        const plantillaId = selectPlantilla.value;
        if (!plantillaId || selectPlantilla.disabled) {
            alert("Por favor, selecciona una Plantilla de Demanda v√°lida antes de continuar.");
            return;
        }

        // --- NUEVO: VALIDACI√ìN DE FECHAS EN FRONTEND ---
        const fechaInicioVal = document.getElementById('fecha_inicio').value;
        const fechaFinVal = document.getElementById('fecha_fin').value;

        if (!fechaInicioVal || !fechaFinVal) {
            mostrarError("Debes seleccionar ambas fechas.");
            return;
        }

        const fInicio = new Date(fechaInicioVal);
        const fFin = new Date(fechaFinVal);
        
        // Calcular diferencia en d√≠as (milisegundos -> d√≠as)
        const diffTime = fFin - fInicio;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir el √∫ltimo d√≠a

        if (diffDays < 7) {
            mostrarError(`El per√≠odo m√≠nimo es de 7 d√≠as. Has seleccionado ${diffDays}.`);
            return;
        }
        if (diffDays > 31) {
            mostrarError(`El per√≠odo m√°ximo es de 31 d√≠as. Has seleccionado ${diffDays}.`);
            return;
        }
        // -----------------------------------------------

        const payload = {
            fecha_inicio: fechaInicioVal,
            fecha_fin: fechaFinVal,
            especialidad: selectEspecialidad.value,
            plantilla_id: plantillaId 
        };

        // UI Loading
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Enviando...`;
        container.classList.remove('d-none', 'alert-success', 'alert-danger');
        container.classList.add('alert-info');
        badge.className = 'badge bg-info text-dark';
        badge.innerText = 'Encolado';
        spinner.classList.remove('d-none');

        try {
            const response = await fetch('/api/planificar/iniciar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                msg.innerText = `Job ID: ${data.job_id}. Optimizando...`;
                pollEstado(data.job_id); 
            } else {
                mostrarError("Error al iniciar: " + (data.error || "Desconocido"));
            }
        } catch (error) {
            console.error(error);
            mostrarError("Error de conexi√≥n con el servidor.");
        }
    }

    // ... (Tu funci√≥n pollEstado y mostrarError siguen igual) ...
    // Asegurate de copiar las funciones pollEstado, exitoPlanificacion y mostrarError 
    // que ya ten√≠as en el archivo anterior.
    
    // Solo pego pollEstado aqu√≠ para referencia, us√° la que ya ten√≠as
    async function pollEstado(jobId) {
        const intervalo = setInterval(async () => {
            try {
                const res = await fetch(`/api/planificar/estado/${jobId}/`);
                const data = await res.json();
                const badge = document.getElementById('estado-badge');

                if (data.status === 'completed') {
                    clearInterval(intervalo);
                    exitoPlanificacion(data);
                } else if (data.status === 'failed' || data.status === 'error') {
                    clearInterval(intervalo);
                    mostrarError(data.error || "El algoritmo fall√≥.");
                } else {
                    badge.className = 'badge bg-warning text-dark';
                    badge.innerText = 'Procesando';
                }
            } catch (e) {
                clearInterval(intervalo);
                mostrarError("Error de conexi√≥n.");
            }
        }, 2000);
    }
    
    function exitoPlanificacion(data) {
        const container = document.getElementById('resultado-container');
        const spinner = document.getElementById('loading-spinner');
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');
        const btn = document.getElementById('btn-accion');

        container.classList.remove('alert-info');
        container.classList.add('alert-success');
        spinner.classList.add('d-none');

        badge.className = 'badge bg-success';
        badge.innerText = '¬°Finalizado!';
        
        msg.innerHTML = `<strong>Optimizaci√≥n exitosa.</strong><br>Fitness: ${parseFloat(data.fitness).toFixed(2)}`;

        const urlBase = "{% url 'ver_cronograma' 0 %}"; 
        const urlFinal = urlBase.replace('0', data.cronograma_id);

        btn.disabled = false;
        btn.className = "btn btn-success btn-lg shadow";
        btn.innerHTML = `<i class="bi bi-eye"></i> Ver Cronograma Generado`;
        btn.onclick = function() { window.location.href = urlFinal; };
    }

    function mostrarError(mensaje) {
        const container = document.getElementById('resultado-container');
        const spinner = document.getElementById('loading-spinner');
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');
        const btn = document.getElementById('btn-accion');

        // 1. Asegurar que el contenedor sea visible (ESTO FALTABA)
        container.classList.remove('d-none');
        
        // 2. Configurar estilos de error
        container.classList.remove('alert-info', 'alert-success');
        container.classList.add('alert-danger');
        
        // 3. Ocultar spinner y configurar texto
        spinner.classList.add('d-none');
        badge.className = 'badge bg-danger';
        badge.innerText = 'Fall√≥';
        msg.innerText = mensaje;

        // 4. Resetear bot√≥n
        btn.disabled = false;
        btn.innerText = "üöÄ Reintentar";
        btn.onclick = iniciarGeneracion; 
    }
</script>
{% endblock %}