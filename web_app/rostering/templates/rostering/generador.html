{% extends "base.html" %}

{% block title %}Generador de Turnos{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 text-center">
        <h2 class="mb-4">‚ö° Generador de Planificaci√≥n</h2>
        
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-light text-start">
                <h5 class="mb-0 text-muted"><i class="bi bi-sliders"></i> Configuraci√≥n del Escenario</h5>
            </div>
            <div class="card-body text-start p-4">
                <form id="form-generador">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Inicio</label>
                            <input type="date" id="fecha_inicio" class="form-control" value="2025-11-01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Fin</label>
                            <input type="date" id="fecha_fin" class="form-control" value="2025-11-30">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Especialidad</label>
                            <select id="especialidad" class="form-select">
                                <option value="MEDICO">M√©dicos (Turnos 12hs)</option>
                                <option value="ENFERMERO">Enfermeros (Turnos 8hs)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" id="btn-accion" class="btn btn-primary btn-lg" onclick="iniciarGeneracion()">
                            üöÄ Ejecutar Algoritmo Gen√©tico
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="resultado-container" class="alert alert-secondary d-none text-center shadow-sm">
            <h4 class="mt-2">Estado: <span id="estado-badge" class="badge bg-secondary">Iniciando...</span></h4>
            
            <div id="loading-spinner" class="my-3 d-none">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>

            <p id="mensaje-estado" class="fs-5 text-muted">Preparando motor de optimizaci√≥n...</p>
        </div>

        <hr class="my-5">

        <div class="d-flex justify-content-center">
            <a href="{% url 'cronograma_list' %}" class="btn btn-link text-muted text-decoration-none">
                <i class="bi bi-arrow-left"></i> Ir al listado de planificaciones
            </a>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales para elementos del DOM
    const btn = document.getElementById('btn-accion');
    const container = document.getElementById('resultado-container');
    const badge = document.getElementById('estado-badge');
    const msg = document.getElementById('mensaje-estado');
    const spinner = document.getElementById('loading-spinner');

    async function iniciarGeneracion() {
        // 1. Obtener datos
        const payload = {
            fecha_inicio: document.getElementById('fecha_inicio').value,
            fecha_fin: document.getElementById('fecha_fin').value,
            especialidad: document.getElementById('especialidad').value
        };

        // 2. Actualizar UI (Modo Carga)
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando solicitud...`;
        
        container.classList.remove('d-none');
        container.classList.remove('alert-success', 'alert-danger');
        container.classList.add('alert-info');
        
        badge.className = 'badge bg-info text-dark';
        badge.innerText = 'Encolado';
        spinner.classList.remove('d-none'); // Mostrar spinner grande

        try {
            // 3. POST a la API
            const response = await fetch('/api/planificar/iniciar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                msg.innerText = `Job ID: ${data.job_id}. Optimizando turnos...`;
                btn.innerText = "‚è≥ Procesando... Por favor espere";
                
                // 4. Iniciar Polling
                pollEstado(data.job_id);
            } else {
                mostrarError("Error al iniciar: " + (data.error || "Desconocido"));
            }

        } catch (error) {
            console.error(error);
            mostrarError("Error de conexi√≥n con el servidor.");
        }
    }

    async function pollEstado(jobId) {
        const intervalo = setInterval(async () => {
            try {
                const res = await fetch(`/api/planificar/estado/${jobId}/`);
                const data = await res.json();

                if (data.status === 'completed') {
                    clearInterval(intervalo);
                    exitoPlanificacion(data);
                } else if (data.status === 'failed' || data.status === 'error') {
                    clearInterval(intervalo);
                    mostrarError(data.error || "El algoritmo fall√≥.");
                } else {
                    // Sigue 'running'
                    badge.className = 'badge bg-warning text-dark';
                    badge.innerText = 'Procesando';
                }
            } catch (e) {
                clearInterval(intervalo);
                mostrarError("Perdimos conexi√≥n con el monitor de estado.");
            }
        }, 2000); // Consultar cada 2 segundos
    }

    function exitoPlanificacion(data) {
        // UI de √âxito
        container.classList.remove('alert-info');
        container.classList.add('alert-success');
        spinner.classList.add('d-none'); // Ocultar spinner

        badge.className = 'badge bg-success';
        badge.innerText = '¬°Finalizado!';
        
        msg.innerHTML = `
            <strong>Optimizaci√≥n exitosa.</strong><br>
            Fitness: ${parseFloat(data.fitness).toFixed(2)}
        `;

        // TRUCO DE DJANGO + JS: 
        // Usamos un ID placeholder '0' y lo reemplazamos por el ID real.
        // Esto asegura que la URL sea la correcta definida en urls.py
        const urlBase = "{% url 'ver_cronograma' 0 %}"; 
        const urlFinal = urlBase.replace('0', data.cronograma_id);

        // Transformar el bot√≥n principal en "Ver Resultado"
        btn.disabled = false;
        btn.className = "btn btn-success btn-lg shadow"; // Estilo verde vibrante
        btn.innerHTML = `<i class="bi bi-eye"></i> Ver Cronograma Generado`;
        
        // Asignar la redirecci√≥n
        btn.onclick = function() {
            window.location.href = urlFinal;
        };
    }

    function mostrarError(mensaje) {
        container.classList.remove('alert-info');
        container.classList.add('alert-danger');
        spinner.classList.add('d-none');
        
        badge.className = 'badge bg-danger';
        badge.innerText = 'Fall√≥';
        msg.innerText = mensaje;

        btn.disabled = false;
        btn.innerText = "üöÄ Reintentar";
        // Resetear onclick por si hab√≠a cambiado
        btn.onclick = iniciarGeneracion; 
    }
</script>
{% endblock %}