{% extends "base.html" %}

{% block title %}Generador de Turnos{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 text-center">
        <h2 class="mb-4">‚ö° Generador de Planificaci√≥n</h2>
        
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-light text-start">
                <h5 class="mb-0 text-muted"><i class="bi bi-sliders"></i> Configuraci√≥n del Escenario</h5>
            </div>
            <div class="card-body text-start p-4">
                <form id="form-generador">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Inicio</label>
                            <input type="date" id="fecha_inicio" class="form-control" value="2025-11-01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Fin</label>
                            <input type="date" id="fecha_fin" class="form-control" value="2025-11-30">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Especialidad</label>
                            <select id="especialidad" class="form-select" onchange="cargarPlantillas()">
                                <option value="MEDICO">M√©dicos (Turnos 12hs)</option>
                                <option value="ENFERMERO">Enfermeros (Turnos 8hs)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Plantilla de Demanda</label>
                            <select id="plantilla" class="form-select" required>
                                <option value="" disabled selected>-- Cargando... --</option>
                            </select>
                            <div class="form-text text-muted small">Define cu√°nta gente se necesita por turno.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" id="btn-accion" class="btn btn-primary btn-lg" onclick="iniciarGeneracion()">
                            üöÄ Ejecutar Algoritmo Gen√©tico
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="resultado-container" class="alert alert-secondary d-none text-center shadow-sm">
            <h4 class="mt-2">Estado: <span id="estado-badge" class="badge bg-secondary">Iniciando...</span></h4>
            <div id="loading-spinner" class="my-3 d-none">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            </div>
            <p id="mensaje-estado" class="fs-5 text-muted">Preparando motor de optimizaci√≥n...</p>
        </div>

        <hr class="my-5">
        <div class="d-flex justify-content-center">
            <a href="{% url 'cronograma_list' %}" class="btn btn-link text-muted text-decoration-none">
                <i class="bi bi-arrow-left"></i> Ir al listado de planificaciones
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    const selectEspecialidad = document.getElementById('especialidad');
    const selectPlantilla = document.getElementById('plantilla');

    // 3. FUNCI√ìN PARA CARGAR PLANTILLAS DESDE LA API
    async function cargarPlantillas() {
        const especialidad = selectEspecialidad.value;
        selectPlantilla.innerHTML = '<option value="" disabled selected>Cargando...</option>';
        selectPlantilla.disabled = true;

        try {
            const res = await fetch(`/api/plantillas/?especialidad=${especialidad}`);
            const data = await res.json();

            selectPlantilla.innerHTML = ''; // Limpiar
            
            if (data.plantillas.length === 0) {
                const opt = document.createElement('option');
                opt.text = "‚ö†Ô∏è No hay plantillas creadas para esta especialidad";
                selectPlantilla.add(opt);
            } else {
                data.plantillas.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = p.nombre;
                    selectPlantilla.add(opt);
                });
                selectPlantilla.disabled = false;
            }
        } catch (error) {
            console.error("Error cargando plantillas:", error);
            selectPlantilla.innerHTML = '<option>Error al cargar</option>';
        }
    }

    // Cargar plantillas al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', cargarPlantillas);


    // 4. ACTUALIZAR LA FUNCI√ìN DE INICIO PARA DETECTAR EL ERROR RF04
    async function iniciarGeneracion() {
        const btn = document.getElementById('btn-accion');
        const container = document.getElementById('resultado-container');
        const badge = document.getElementById('estado-badge');
        const spinner = document.getElementById('loading-spinner');
        const msg = document.getElementById('mensaje-estado');

        // Validar que haya plantilla seleccionada
        const plantillaId = selectPlantilla.value;
        if (!plantillaId || selectPlantilla.disabled) {
            alert("Por favor, selecciona una Plantilla de Demanda v√°lida antes de continuar.");
            return;
        }

        const payload = {
            fecha_inicio: document.getElementById('fecha_inicio').value,
            fecha_fin: document.getElementById('fecha_fin').value,
            especialidad: selectEspecialidad.value,
            plantilla_id: plantillaId
        };

        // UI Loading
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Verificando y Enviando...`;
        container.classList.remove('d-none', 'alert-success', 'alert-danger');
        container.classList.add('alert-info');
        badge.className = 'badge bg-info text-dark';
        badge.innerText = 'Validando...';
        spinner.classList.remove('d-none');
        msg.innerText = "Verificando dotaci√≥n y enviando al motor...";

        try {
            const response = await fetch('/api/planificar/iniciar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                // √âXITO (200)
                msg.innerText = `Job ID: ${data.job_id}. Optimizando...`;
                badge.innerText = 'Encolado';
                pollEstado(data.job_id);
            } else {
                // ERROR (400, 422, 500)
                
                // --- DETECCI√ìN DE ERROR RF04 ---
                if (data.tipo_error === 'FALTA_DOTACION') {
                    // Ocultamos el spinner de carga porque no vamos a reintentar autom√°ticamente
                    resetUIState();
                    // Mostramos el Modal Amigable
                    mostrarModalDotacion(data.detalles);
                } else {
                    // Error gen√©rico
                    mostrarError("Error al iniciar: " + (data.error || "Desconocido"));
                }
            }
        } catch (error) {
            console.error(error);
            mostrarError("Error de conexi√≥n con el servidor.");
        }
    }

    // --- NUEVA FUNCI√ìN PARA EL MODAL ---
    function mostrarModalDotacion(detalles) {
        // 1. Llenar datos num√©ricos
        document.getElementById('txt-oferta').innerText = detalles.horas_disponibles;
        document.getElementById('txt-demanda').innerText = detalles.horas_necesarias;
        document.getElementById('txt-deficit').innerText = detalles.deficit;
        document.getElementById('txt-porcentaje').innerText = detalles.porcentaje_cobertura + "%";
        document.getElementById('txt-empleados').innerText = detalles.empleados_activos;

        // 2. Configurar Barra de Progreso Visual
        let porcentaje = Math.min(detalles.porcentaje_cobertura, 100);
        let barra = document.getElementById('bar-capacidad');
        
        barra.style.width = porcentaje + '%';
        
        // Cambiar color seg√∫n gravedad
        barra.className = 'progress-bar'; // Reset
        if(porcentaje < 30) {
            barra.classList.add('bg-danger'); // Rojo si es muy cr√≠tico
        } else if (porcentaje < 80) {
            barra.classList.add('bg-warning', 'text-dark'); // Amarillo
        } else {
            barra.classList.add('bg-success'); // Verde (aunque si salt√≥ el error, dudo que llegue ac√°)
        }

        // -------------------------------------------------------
        // NUEVO: Configurar el bot√≥n "Modificar Plantilla"
        // -------------------------------------------------------
        const plantillaSelect = document.getElementById('plantilla');
        const plantillaId = plantillaSelect.value;
        const btnIr = document.getElementById('btn-ir-plantilla');

        if (plantillaId) {
            // Generamos la URL base con Django usando un ID placeholder (0)
            // y luego lo reemplazamos por el ID real en Javascript.
            const urlBase = "{% url 'plantilla_detail' 0 %}";
            const urlFinal = urlBase.replace('0', plantillaId);
            
            btnIr.href = urlFinal;
            btnIr.classList.remove('disabled');
        } else {
            // Por seguridad, si no hay ID, deshabilitamos
            btnIr.href = "#";
            btnIr.classList.add('disabled');
        }
        // -------------------------------------------------------

        // 3. Abrir Modal (Usando Bootstrap 5 API)
        const modalEl = document.getElementById('modalErrorDotacion');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    // Funci√≥n auxiliar para resetear el bot√≥n si abre el modal (para que no quede cargando)
    function resetUIState() {
        const btn = document.getElementById('btn-accion');
        const container = document.getElementById('resultado-container');
        
        btn.disabled = false;
        btn.innerHTML = `üöÄ Ejecutar Algoritmo Gen√©tico`;
        
        // Ocultamos la caja de estado "Validando..."
        container.classList.add('d-none');
    }

    // ... (Tu funci√≥n pollEstado y mostrarError siguen igual) ...
    // Asegurate de copiar las funciones pollEstado, exitoPlanificacion y mostrarError 
    // que ya ten√≠as en el archivo anterior.
    
    // Solo pego pollEstado aqu√≠ para referencia, us√° la que ya ten√≠as
    async function pollEstado(jobId) {
        const intervalo = setInterval(async () => {
            try {
                const res = await fetch(`/api/planificar/estado/${jobId}/`);
                const data = await res.json();
                const badge = document.getElementById('estado-badge');

                if (data.status === 'completed') {
                    clearInterval(intervalo);
                    exitoPlanificacion(data);
                } else if (data.status === 'failed' || data.status === 'error') {
                    clearInterval(intervalo);
                    mostrarError(data.error || "El algoritmo fall√≥.");
                } else {
                    badge.className = 'badge bg-warning text-dark';
                    badge.innerText = 'Procesando';
                }
            } catch (e) {
                clearInterval(intervalo);
                mostrarError("Error de conexi√≥n.");
            }
        }, 2000);
    }
    
    function exitoPlanificacion(data) {
        const container = document.getElementById('resultado-container');
        const spinner = document.getElementById('loading-spinner');
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');
        const btn = document.getElementById('btn-accion');

        container.classList.remove('alert-info');
        container.classList.add('alert-success');
        spinner.classList.add('d-none');

        badge.className = 'badge bg-success';
        badge.innerText = '¬°Finalizado!';
        
        msg.innerHTML = `<strong>Optimizaci√≥n exitosa.</strong><br>Fitness: ${parseFloat(data.fitness).toFixed(2)}`;

        const urlBase = "{% url 'ver_cronograma' 0 %}"; 
        const urlFinal = urlBase.replace('0', data.cronograma_id);

        btn.disabled = false;
        btn.className = "btn btn-success btn-lg shadow";
        btn.innerHTML = `<i class="bi bi-eye"></i> Ver Cronograma Generado`;
        btn.onclick = function() { window.location.href = urlFinal; };
    }

    function mostrarError(mensaje) {
        const container = document.getElementById('resultado-container');
        const spinner = document.getElementById('loading-spinner');
        const badge = document.getElementById('estado-badge');
        const msg = document.getElementById('mensaje-estado');
        const btn = document.getElementById('btn-accion');

        container.classList.remove('alert-info');
        container.classList.add('alert-danger');
        spinner.classList.add('d-none');
        
        badge.className = 'badge bg-danger';
        badge.innerText = 'Fall√≥';
        msg.innerText = mensaje;

        btn.disabled = false;
        btn.innerText = "üöÄ Reintentar";
        btn.onclick = iniciarGeneracion; 
    }
</script>
<div class="modal fade" id="modalErrorDotacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Validaci√≥n de Dotaci√≥n Fallida
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                
                <div class="text-center mb-4">
                    <h4 class="text-danger fw-bold">Imposible Generar Cronograma</h4>
                    <p class="text-muted">La demanda requerida supera la capacidad m√°xima te√≥rica del personal activo.</p>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span>Oferta Actual (<span id="txt-oferta">0</span> hs)</span>
                        <span class="text-danger">Demanda (<span id="txt-demanda">0</span> hs)</span>
                    </div>
                    <div class="progress" style="height: 25px; background-color: #e9ecef;">
                        <div id="bar-capacidad" class="progress-bar bg-danger" role="progressbar" style="width: 0%">
                            <span id="txt-porcentaje" class="fw-bold text-white drop-shadow">0%</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                            Faltan cubrir <span id="txt-deficit" class="fw-bold">0</span> horas (aprox)
                        </span>
                    </div>
                </div>

                <div class="alert alert-warning d-flex align-items-start small" role="alert">
                    <i class="bi bi-info-circle-fill fs-5 me-2"></i>
                    <div>
                        <strong>Nota importante sobre capacidad:</strong><br>
                        Para garantizar una cobertura saludable, la capacidad del personal deber√≠a ser 
                        <strong>al menos un 15% superior</strong> a la demanda. Esto es necesario para cubrir francos obligatorios, 
                        preferencias, indisponibilidades y evitar la fatiga del equipo.
                        <br>
                        <em>Incluso si los n√∫meros fueran iguales, el algoritmo no podr√≠a cubrir todos los turnos debido a estas restricciones.</em>
                    </div>
                </div>

                <div class="card bg-light border-0 mt-3">
                    <div class="card-body">
                        <h6 class="fw-bold text-dark mb-3"><i class="bi bi-lightbulb-fill text-warning"></i> Acciones Sugeridas</h6>
                        <ul class="mb-0 text-muted small ps-3">
                            <li class="mb-2">
                                <strong>Revisar Personal:</strong> Actualmente hay <strong id="txt-empleados" class="text-dark">0</strong> empleados activos. Verifica si hay personal inactivo o licencias mal cargadas.
                            </li>
                            <li class="mb-2">
                                <strong>Ajustar Plantilla:</strong> Reduc√≠ la cantidad de profesionales requeridos por turno en la configuraci√≥n de la Plantilla de Demanda.
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Entendido</button>
                <a href="#" id="btn-ir-plantilla" class="btn btn-primary">
                    <i class="bi bi-pencil-square"></i> Modificar Plantilla
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}