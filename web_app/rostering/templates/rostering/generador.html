{% extends "base.html" %}

{% block title %}Generar Planificación · Hospital Planner{% endblock %}

{% block content %}
<div class="container py-3" style="max-width: 1100px;">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Generar Planificación</h1>
            <p class="text-muted fs-5 mb-0">Optimización de cronogramas de guardias</p>
        </div>
    </div>

    <div class="card shadow-sm border-0 generator-card">
        <div class="card-body p-4 p-lg-5 pb-4">
            <form id="form-generador" class="row g-3" novalidate>
                <div class="col-12">
                    <div id="form-warning" class="field-error d-none">
                        <i class="bi bi-exclamation-circle"></i>
                        <span id="form-warning-text"></span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <label class="form-label fw-semibold">Fecha inicio<span class="required-asterisk" aria-hidden="true" style="color: #dc3545; margin-left: 0.25rem; font-weight: 700;">*</span></label>
                    <input type="date" class="form-control" id="fecha_inicio" required>
                    <div class="invalid-feedback">Ingresá una fecha válida.</div>
                </div>
                <div class="col-sm-6">
                    <label class="form-label fw-semibold">Fecha fin<span class="required-asterisk" aria-hidden="true" style="color: #dc3545; margin-left: 0.25rem; font-weight: 700;">*</span></label>
                    <input type="date" class="form-control" id="fecha_fin" required>
                    <div class="invalid-feedback">La fecha fin debe ser posterior al inicio.</div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Especialidad<span class="required-asterisk" aria-hidden="true" style="color: #dc3545; margin-left: 0.25rem; font-weight: 700;">*</span></label>
                    <div class="custom-select-wrapper">
                        <select class="form-select d-none" id="especialidad" required>
                            <option value="" selected disabled>Seleccioná una especialidad</option>
                            {% for esp in especialidades_disponibles %}
                                <option value="{{ esp.code }}">{{ esp.label }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-dropdown">
                            <div class="custom-dropdown-header" tabindex="0">Seleccioná una especialidad</div>
                            <div class="custom-dropdown-menu">
                                    <div class="custom-option" data-value="">Seleccioná una especialidad</div>
                                    {% for esp in especialidades_disponibles %}
                                        <div class="custom-option" data-value="{{ esp.code }}">{{ esp.label }}</div>
                                    {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Plantilla de demanda<span class="required-asterisk" aria-hidden="true" style="color: #dc3545; margin-left: 0.25rem; font-weight: 700;">*</span></label>
                    <div class="custom-select-wrapper">
                        <select class="form-select d-none" id="plantilla_id" required disabled>
                            <option value="" selected>Seleccioná una especialidad primero</option>
                        </select>
                        <div class="custom-dropdown">
                            <div class="custom-dropdown-header" tabindex="0">Seleccioná una especialidad primero</div>
                            <div class="custom-dropdown-menu">
                                <div class="custom-option" data-value="">Seleccioná una especialidad primero</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-text">Definiciones de cobertura por día y turno.</div>
                </div>

                <div class="col-12 d-flex flex-column align-items-center gap-3 mt-5 mb-0">
                    <button type="submit" id="btn-iniciar" class="btn btn-primary fw-semibold px-4" style="min-width: 220px;">
                        <i class="bi bi-play-fill me-1"></i> Iniciar optimización
                    </button>
                    <button type="button" id="btn-reset" class="btn btn-outline-secondary fw-semibold px-4 d-none" style="min-width: 220px;">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reiniciar
                    </button>
                </div>

                <div id="panel-estado" class="col-12 mt-3 d-none">
                    <div class="rounded-3 p-4 status-panel">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5 class="fw-bold mb-0" style="color: #2f3e4c; letter-spacing: 0.3px;">Estado de la ejecución</h5>
                            <span class="badge" id="estado-badge" style="background-color: #6c757d; font-weight: 600; font-size: 0.75rem; padding: 0.4rem 0.6rem;">Listo</span>
                        </div>

                        <div class="progress mb-3" style="height: 8px; background-color: #e9ecef; border-radius: 8px; overflow: hidden;">
                            <div id="barra-progreso" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%; background-color: #0d6efd;"></div>
                        </div>

                        <div id="estado-mensajes" class="small text-muted mt-2">
                            Completa el formulario y presioná "Iniciar optimización".
                        </div>

                        <div id="resultado-ok" class="mt-3 d-none">
                            <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <div>Planificación generada y guardada con éxito.</div>
                            </div>
                            <div class="d-flex gap-2">
                                <a id="link-ver" href="#" class="btn btn-success">
                                    <i class="bi bi-table me-1"></i> Ver cronograma
                                </a>
                                <a id="link-analisis" href="#" class="btn btn-outline-success">
                                    <i class="bi bi-bar-chart-line me-1"></i> Ver análisis
                                </a>
                            </div>
                        </div>

                        <div id="resultado-error" class="mt-3 d-none">
                            <div class="alert alert-danger d-flex align-items-center mb-0" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div id="error-text">Ocurrió un error durante la ejecución.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="mt-3 small text-muted">
        Consejo: Antes de ejecutar, revisá que exista un esquema de turnos, personal activo y una plantilla de demanda para la especialidad seleccionada.
    </div>
</div>

<div class="modal fade" id="modalErrorDotacion" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            
            <div class="modal-header bg-white border-bottom-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body pt-2">
                        <div class="text-center mb-3">
                                <div class="icon-top mx-auto mb-3">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                                <h4 class="fw-bold mb-2" style="color: #2f3e4c;">Dotación insuficiente</h4>
                            </div>

                    <div class="card mb-3 border-0 bg-light" id="card-senior">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-uppercase small text-muted">Seniors</span>
                                <span class="badge" id="badge-senior">OK</span>
                            </div>
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Oferta: <strong id="val-oferta-senior">0</strong>h</span>
                                <span>Demanda: <strong id="val-demanda-senior">0</strong>h</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div id="bar-senior" class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="msg-senior" class="text-end text-danger small fw-bold mt-1" style="font-size: 0.75rem;"></div>
                        </div>
                    </div>

                    <div class="card mb-3 border-0 bg-light" id="card-junior">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-uppercase small text-muted">Juniors</span>
                                <span class="badge" id="badge-junior">OK</span>
                            </div>
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Oferta: <strong id="val-oferta-junior">0</strong>h</span>
                                <span>Demanda: <strong id="val-demanda-junior">0</strong>h</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div id="bar-junior" class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="msg-junior" class="text-end text-danger small fw-bold mt-1" style="font-size: 0.75rem;"></div>
                        </div>
                    </div>

                <div id="alerta-ausencias" class="alert alert-warning d-flex align-items-center py-2 px-3 d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <div class="small lh-sm">Se descontaron <strong id="val-ausencias">0</strong> horas por ausencias durante este período, reduciendo la capacidad disponible para cubrir la demanda.</div>
                </div>

                <div class="text-center mt-3">
                    <small class="text-muted fst-italic" style="font-size: 0.7rem;">
                        * El cálculo incluye un margen de seguridad del <span id="val-margen">10</span>% para descansos.
                    </small>
                </div>
            </div>

            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="btn-ver-detalle" href="#" class="btn btn-primary d-none">Gestionar Empleados</a>
            </div>
        </div>
    </div>
</div>

<!-- Navigation confirm modal (warn when job in progress) -->
<!-- Navigation confirm modal (styled like plantilla_detail conflict modal) -->
<div class="modal fade" id="navigationConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header border-0 pb-0 pt-4 px-4" style="background: white;">
                <button type="button" class="btn-close position-absolute" style="top: 16px; right: 16px; opacity: 0.5;" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center px-5 pb-4 pt-2">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0d6efd;">
                        <i class="bi bi-exclamation-lg" style="font-size: 2rem; color: #0d6efd;"></i>
                    </div>
                </div>

                <h4 class="fw-bold mb-3" style="color: #2f3e4c;">¿Estás seguro?</h4>

                <div class="mb-3 p-4 text-center" style="background-color: #ffffff; border-radius: 10px; border: 1px solid #e0e5ec; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
                    <p class="mb-2 small text-muted">La optimización está en ejecución. Si salís ahora, se perderá el progreso y no podrá recuperarse.</p>
                </div>

                <!-- informational line removed as requested -->
            </div>
            <div class="modal-footer border-0 bg-white justify-content-center gap-2 pb-4">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="border-radius: 10px; font-weight: 600; border: 1px solid #dee2e6; min-width: 160px;">Permanecer aquí</button>
                <button type="button" id="confirmLeaveBtn" class="btn btn-primary px-4 py-2" style="border-radius: 10px; font-weight: 600; min-width: 160px;">Salir y perder progreso</button>
            </div>
        </div>
    </div>
</div>

<style>
    body { background-color: #EFF3F8 !important; }
    footer { background-color: #EFF3F8 !important; border-top-color: #e0e5ec !important; }
    .generator-card { border-radius: 14px; }
    .icon-circle { width: 64px; height: 64px; background: rgba(13,110,253,.10); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
    .page-title { color: #2f3e4c; letter-spacing: .2px; }

    .status-panel { background: #fff; border: 1px solid #eef0f3; }

    .form-label { color: #2f3e4c; }
    
    /* Custom Select Styles */
    .custom-select-wrapper {
        position: relative;
        display: block;
    }
    
    .form-select {
        height: 48px;
        border-radius: 10px;
        border: 1px solid #e0e5ec;
        background-color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        font-size: 0.95rem;
        color: #2f3e4c;
        padding: 12px 16px;
    }
    
    .custom-dropdown {
        position: relative;
        /* Permitir interacción en todo el dropdown */
        pointer-events: auto;
    }
    
    .custom-dropdown-header {
        height: 48px;
        border-radius: 10px;
        border: 1px solid #0d6efd;
        background-color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 12px 16px;
        font-size: 0.95rem;
        color: #495057;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
        pointer-events: auto;
    }
    
    .custom-dropdown-header:hover {
        background-color: #EFF3F8;
    }
    
    .custom-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #ffffff;
        border: none;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        border-radius: 10px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        pointer-events: none;
        z-index: 100;
        /* Sin margen ni padding cuando está cerrado para evitar caja angosta */
        margin-top: 0;
        padding: 0;
        animation: fadeInDown 0.3s ease;
        -webkit-overflow-scrolling: touch;
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Abrir menú cuando el wrapper tiene la clase 'open' */
    .custom-dropdown.open .custom-dropdown-menu {
        /* Limitar alto y permitir scroll cuando hay muchas opciones */
        max-height: 300px;
        max-height: min(300px, calc(100vh - 180px));
        pointer-events: auto;
        opacity: 1;
        margin-top: 0.5rem;
        padding: 0.5rem 0;
        overflow-y: auto;
        overscroll-behavior: contain;
    }
    
    .custom-option {
        padding: 0.5rem 1.2rem;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        border-bottom: none;
        font-weight: 500;
    }
    
    .custom-option:hover {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
        padding-left: 1.4rem;
    }
    
    .custom-option:first-child {
        background-color: transparent;
        color: #495057;
        font-weight: 500;
        cursor: default;
    }
    
    .custom-option:first-child:hover {
        background-color: transparent;
        color: #495057;
        padding-left: 1.2rem;
    }
    
    .form-select:disabled ~ .custom-dropdown .custom-dropdown-header {
        background-color: #f5f5f5;
        border-color: #e0e5ec;
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .form-control {
        height: 48px;
        border-radius: 10px;
        border: 1px solid #e0e5ec;
        background-color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        font-size: 0.95rem;
        color: #2f3e4c;
        padding: 12px 16px;
    }
    
    .form-control:hover {
        background-color: #EFF3F8;
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }
    
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        background-color: #ffffff;
    }

    /* Invalid state (same look used elsewhere) */
    .is-invalid {
        border-color: #c41c3b !important;
        box-shadow: 0 0 0 0.15rem rgba(196,28,59,0.12) !important;
        color: #c41c3b !important;
    }
    .custom-dropdown-header.is-invalid {
        border-color: #c41c3b !important;
        color: #c41c3b !important;
        box-shadow: 0 0 0 0.15rem rgba(196,28,59,0.15);
    }

    /* Warning estilo login */
    .field-error {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0.35rem;
        color: #c41c3b;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .field-error i { font-size: 0.9rem; }
    
    input[type="date"]::-webkit-calendar-picker-indicator { filter: hue-rotate(190deg) saturate(1.2); opacity: 0.8; cursor: pointer; }
    input[type="date"] { padding-right: 1rem; }

    #estado-badge { font-weight: 600; }
    #barra-progreso { transition: width .4s ease; }

    @media (max-width: 575px){
        .icon-circle{ width: 56px; height: 56px; }
    }

    /* --- Estilos específicos para el modal de Dotación Insuficiente --- */
    #modalErrorDotacion .modal-content { border-radius: 16px; overflow: hidden; box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12); }
    #modalErrorDotacion .modal-header { background: #ffffff; border-bottom: 0; padding: 1rem 1.25rem; }
    #modalErrorDotacion .modal-title { color: #c41c3b; font-size: 1.05rem; display: flex; align-items: center; gap: 0.5rem; }
    #modalErrorDotacion .modal-title i { font-size: 1.25rem; }

    #modalErrorDotacion .modal-body { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    /* Estilo del párrafo explicativo: más grande y centrado */
    #modalErrorDotacion .modal-body p.text-muted.modal-explain { color: #6c757d; font-size: 0.95rem; margin-bottom: .8rem; font-style: normal; text-align: center; line-height: 1.35; }

    /* Aviso puntual (pico) estilo tarjeta rosada) */
    #alerta-pico { background-color: #fdecea; border: 1px solid #f5c6cb; color: #8a1f2d; border-radius: 10px; }
    #alerta-pico i { color: #c41c3b; font-size: 1.15rem; }
    #alerta-pico #texto-pico { font-size: 0.95rem; }

    /* Tarjetas internas: seniors / juniors */
    #modalErrorDotacion .card { border-radius: 10px; box-shadow: none; border: 1px solid #eef0f3; background: #ffffff; }
    #modalErrorDotacion .card-body { padding: 0.7rem 0.9rem; }
    #modalErrorDotacion .card .fw-bold.text-uppercase { letter-spacing: .6px; }

    /* Badges más visibles y redondeados */
    #modalErrorDotacion .badge { font-weight: 700; border-radius: 999px; padding: .38rem .65rem; font-size: 0.78rem; }
    /* Ocultar el texto de la badge cuando está en estado de DÉFICIT (bg-danger) */
    #modalErrorDotacion .badge.bg-danger { color: transparent; text-shadow: none; }
    /* Quitar la mancha roja (badge) visualmente dentro del modal */
    #modalErrorDotacion .badge.bg-danger { display: none !important; }

    /* Barras de progreso redondeadas y más altas */
    #modalErrorDotacion .progress { height: 8px; background-color: #f3f5f7; border-radius: 999px; overflow: hidden; }
    #modalErrorDotacion .progress .progress-bar { border-radius: 999px; transition: width .4s ease; }

    /* Mensajes de déficit/ exceso */
    #modalErrorDotacion .text-end.small { font-size: 0.78rem; }

    #modalErrorDotacion #msg-senior, #modalErrorDotacion #msg-junior { font-size: 0.82rem; }

    /* Alert de ausencias */
    #modalErrorDotacion #alerta-ausencias { border-radius: 10px; font-size: 0.9rem; }

    /* Footer y botón */
    #modalErrorDotacion .modal-footer { background: #ffffff; border-top: 0; padding: 1rem; display: flex; justify-content: center; }
    /* Estilo general de botones en el footer (no sobreescribir btn-primary) */
    #modalErrorDotacion .modal-footer .btn { border-radius: 10px; font-weight: 600; min-width: 140px; padding: .45rem .8rem; }
    /* Aplicar borde y color solo a botones secundarios (outline) para mantener consistencia) */
    #modalErrorDotacion .modal-footer .btn.btn-outline-secondary { border: 1px solid #bfc6cc; color: #495057; background-color: transparent; }

    /* Ajustes responsivos */
    @media (max-width: 575px){
        #modalErrorDotacion .modal-dialog { max-width: 95%; }
        #modalErrorDotacion .modal-title { font-size: 0.98rem; }
        #modalErrorDotacion .modal-footer .btn { min-width: 100%; }
    }

    /* Aumentar ancho del modal para mejor lectura del contenido */
    #modalErrorDotacion .modal-dialog { max-width: 900px; }
    #modalErrorDotacion .modal-body { padding-top: 0.75rem; padding-bottom: 0.75rem; }

    /* --- Overrides para un look más pulido (ej.: icono circulado, sombras y gradientes) --- */
    /* Icono circular rojo en el título */
    #modalErrorDotacion .modal-title i {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: linear-gradient(180deg, #e86b76 0%, #c41c3b 100%);
        color: #fff;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(196, 28, 59, 0.18);
        font-size: 1rem;
    }

    /* Titular más prominente */
    #modalErrorDotacion .modal-title { font-size: 1.15rem; letter-spacing: .2px; }

    /* Alerta pico estilo tarjeta con sombra sutil y borde interior */
    #alerta-pico { padding: .7rem .9rem; box-shadow: 0 6px 18px rgba(200,30,50,0.06); border-left: 4px solid #f5c6cb; }
    #alerta-pico i { background: transparent; color: #941827; font-size: 1.05rem; }

    /* Cards: fondo gris claro y contenido en caja blanca (efecto tarjeta interna) */
    #modalErrorDotacion .card { background: transparent; border: none; }
    #modalErrorDotacion .card-body { background: #ffffff; border: 1px solid #eef2f5; border-radius: 10px; padding: .9rem; }

    /* Progresos: color suave cuando OK, degradado cuando DÉFICIT */
    #modalErrorDotacion .progress-bar.bg-danger { background: linear-gradient(90deg,#f08a8f 0%,#c41c3b 100%); }
    #modalErrorDotacion .progress-bar.bg-success { background: linear-gradient(90deg,#7ad38a 0%,#2ea44a 100%); }

    /* Texto de valores mejor alineado */
    #modalErrorDotacion .d-flex.justify-content-between.small { font-size: 0.92rem; }

    /* Badge estado más consistente con altura */
    #modalErrorDotacion .badge { min-width: 64px; text-align: center; }

    /* Hacer más claro el pequeño pie de nota */
    #modalErrorDotacion .modal-body .text-muted.fst-italic { color: #6b6f76; }

    /* Ajustes móviles: stack más compacto */
    @media (max-width: 420px) {
        #modalErrorDotacion .card-body { padding: .7rem; }
        #modalErrorDotacion .modal-title i { width: 32px; height: 32px; }
    }

    /* Icono grande superior usado en el modal */
    #modalErrorDotacion .icon-top {
        width: 92px;
        height: 92px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 2.5px solid #e86b76;
        box-shadow: 0 6px 20px rgba(232,107,118,0.12);
        background: #fff;
    }
    #modalErrorDotacion .icon-top i { color: #e14b52; font-size: 1.9rem; }
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- FUNCIÓN PARA MOSTRAR EL NUEVO MODAL ---
    function mostrarErrorDotacion(detalles) {
        // ... (Same as your existing code for mostrarErrorDotacion) ...
        // Referencias
        const modalEl = document.getElementById('modalErrorDotacion');
        const modal = new bootstrap.Modal(modalEl);
        
        // --- 1. MOSTRAR MENSAJE DE PICO ESPECÍFICO (SI EXISTE) ---
        let alertaPico = document.getElementById('alerta-pico');
        if (!alertaPico) {
            const modalBody = modalEl.querySelector('.modal-body') || modalEl;
            if (modalBody) {
                alertaPico = document.createElement('div');
                alertaPico.id = 'alerta-pico';
                alertaPico.className = 'alert alert-danger d-flex align-items-center py-2 px-3 mb-3 d-none';
                alertaPico.innerHTML = '<div id="texto-pico" class="small fw-bold"></div>';
                const pIntro = modalBody.querySelector('p.text-muted');
                if (pIntro && typeof pIntro.insertAdjacentElement === 'function') {
                    pIntro.insertAdjacentElement('afterend', alertaPico);
                } else {
                    // fallback: prepend to modal body
                    modalBody.insertBefore(alertaPico, modalBody.firstChild);
                }
            }
        }

        if (detalles.error_pico && detalles.mensaje) {
            const raw = detalles.mensaje || '';
            const texto = raw.replace(/^[Dd][íi]a\s+:/, '').replace(/^[Dd][íi]a\s+/, '');
            document.getElementById('texto-pico').textContent = texto;
            alertaPico.classList.remove('d-none');
        } else {
            alertaPico.classList.add('d-none');
        }

        // --- 2. SENIORS ---
        const s = detalles.senior;
        configurarTarjetaCapacidad('senior', s);

        // --- 3. JUNIORS ---
        const j = detalles.junior;
        configurarTarjetaCapacidad('junior', j);

        // --- 3.5 Calcular estimado de profesionales faltantes (solo para la especialidad actual) ---
        (function(){
            try {
                // Obtener horas faltantes por rol
                const ofertaS = parseFloat(s.oferta || 0);
                const demandaS = parseFloat(s.demanda || 0);
                const faltS = Math.max(0, demandaS - ofertaS);

                const ofertaJ = parseFloat(j.oferta || 0);
                const demandaJ = parseFloat(j.demanda || 0);
                const faltJ = Math.max(0, demandaJ - ofertaJ);

                const totalFaltHoras = Math.ceil((faltS || 0) + (faltJ || 0));

                // Periodo en días: preferimos valor enviado por la UI, fallback a cálculo desde inputs
                let periodDays = window.__generador_period_days || 0;
                if (!periodDays || periodDays <= 0) {
                    const inicioVal = document.getElementById('fecha_inicio')?.value;
                    const finVal = document.getElementById('fecha_fin')?.value;
                    if (inicioVal && finVal) {
                        const a = new Date(inicioVal);
                        const b = new Date(finVal);
                        const diffTime = Math.abs(b - a);
                        periodDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                    }
                }

                // Jornada promedio por semana (configurable aquí); se escala al período
                const DEFAULT_WEEK_HOURS = 38; // puedes cambiar esto o pasar desde settings
                const jornadaPeriodo = (DEFAULT_WEEK_HOURS / 7) * Math.max(1, periodDays);

                let profesionalesEstimados = 0;
                if (jornadaPeriodo > 0) {
                    profesionalesEstimados = Math.ceil(totalFaltHoras / jornadaPeriodo);
                }

                // Crear / actualizar bloque de estimado en el modal
                const modalBody = document.querySelector('#modalErrorDotacion .modal-body');
                    if (modalBody) {
                    let estimEl = modalBody.querySelector('#estimado-profesionales');
                    if (!estimEl) {
                        estimEl = document.createElement('div');
                        estimEl.id = 'estimado-profesionales';
                        estimEl.className = 'text-center mb-3';
                        const titleNode = modalBody.querySelector('.text-center.mb-3');
                        if (titleNode && typeof titleNode.insertAdjacentElement === 'function') {
                            titleNode.insertAdjacentElement('afterend', estimEl);
                        } else {
                            modalBody.insertBefore(estimEl, modalBody.querySelector('.card') || modalBody.firstChild);
                        }
                    }

                                if (totalFaltHoras > 0) {
                                    const faltSInt = Math.ceil(faltS || 0);
                                    const faltJInt = Math.ceil(faltJ || 0);
                                    const totalProfs = Math.max(1, profesionalesEstimados || Math.ceil(totalFaltHoras / Math.max(1, jornadaPeriodo)));
                                    let experiencia = '';
                                    if (faltSInt > 0 && faltJInt > 0) experiencia = '(senior y junior)';
                                    else if (faltSInt > 0) experiencia = '(senior)';
                                    else if (faltJInt > 0) experiencia = '(junior)';

                                    const mensaje = `Faltan aproximadamente ${totalProfs} profesionales ${experiencia} para cubrir la demanda.`;
                                    estimEl.innerHTML = `<div class="fw-bold text-danger" style="font-size:1rem;">${mensaje}</div>`;
                        // Mostrar botón detalle
                        const btnDetalle = document.getElementById('btn-ver-detalle');
                        if (btnDetalle) {
                            const espVal = document.getElementById('especialidad')?.value || '';
                            const inicioVal = document.getElementById('fecha_inicio')?.value || '';
                            const finVal = document.getElementById('fecha_fin')?.value || '';
                            const empleadoListBase = "{% url 'empleado_list' %}";
                            btnDetalle.href = empleadoListBase + `?especialidad=${encodeURIComponent(espVal)}`;
                            btnDetalle.classList.remove('d-none');
                        }
                    } else {
                        estimEl.innerHTML = `<div class="fw-bold text-secondary" style="font-size:0.95rem;">Estimado: no es posible calcular profesionales faltantes con los datos disponibles.</div>`;
                        const btnDetalle = document.getElementById('btn-ver-detalle');
                        if (btnDetalle) btnDetalle.classList.add('d-none');
                    }
                }
            } catch (e) {
                console.error('Error calculando estimado profesionales:', e);
            }
        })();

        // --- 4. GLOBALES ---
        const g = detalles.global || {};
        const alertaAus = document.getElementById('alerta-ausencias');
        
        if (g.ausencias_impacto > 0) {
            document.getElementById('val-ausencias').textContent = g.ausencias_impacto;
            alertaAus.classList.remove('d-none');
        } else {
            alertaAus.classList.add('d-none');
        }
        
        document.getElementById('val-margen').textContent = g.margen_seguridad || 10;

        // Mostrar
        modal.show();
    }

    // Helper para configurar cada tarjeta (Senior/Junior)
    function configurarTarjetaCapacidad(rol, datos) {
        const elOferta = document.getElementById(`val-oferta-${rol}`);
        const elDemanda = document.getElementById(`val-demanda-${rol}`);
        const elBadge = document.getElementById(`badge-${rol}`);
        const elBar = document.getElementById(`bar-${rol}`);
        const elMsg = document.getElementById(`msg-${rol}`);

        elOferta.textContent = datos.oferta;
        elDemanda.textContent = datos.demanda;

        const oferta = parseFloat(datos.oferta);
        const demanda = parseFloat(datos.demanda);
        
        let porcentaje = 100;
        if (demanda > 0) {
            porcentaje = (oferta / demanda) * 100;
        }

        const deficitHoras = demanda > oferta;
        const faltante = demanda - oferta;

        if (deficitHoras) {
            elBadge.className = 'badge bg-danger';
            elBadge.textContent = 'DÉFICIT';
            elBar.className = 'progress-bar bg-danger';
            elBar.style.width = `${Math.min(porcentaje, 100)}%`;
            elMsg.textContent = `Faltan ${Math.ceil(faltante)} horas`;
            elMsg.className = 'text-end text-danger small fw-bold mt-1';
        } else {
            elBadge.className = 'badge bg-success';
            elBadge.textContent = 'CUBIERTO';
            elBar.className = 'progress-bar bg-success';
            elBar.style.width = '100%';
            elMsg.textContent = `Capacidad excedente: ${Math.floor(oferta - demanda)}h`;
            elMsg.className = 'text-end text-success small mt-1';
        }
    }

    // Helper para cerrar todos los dropdowns
    function closeAllDropdowns(exceptDropdown) {
        document.querySelectorAll('.custom-dropdown.open').forEach(d => {
            if (!exceptDropdown || d !== exceptDropdown) d.classList.remove('open');
        });
    }

    // Helpers: configurar un wrapper de dropdown personalizado
    function setupCustomDropdown(wrapper){
        const nativeSelect = wrapper.querySelector('.form-select');
        const header = wrapper.querySelector('.custom-dropdown-header');
        const dropdown = wrapper.querySelector('.custom-dropdown');
        const menu = wrapper.querySelector('.custom-dropdown-menu');

        if (!header || !dropdown || !menu || !nativeSelect) return;

        // Limpiar event listeners anteriores clonando el nodo
        // Esto es necesario porque llamamos a setupCustomDropdown múltiples veces
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
        
        // Re-asignar referencia
        const activeHeader = wrapper.querySelector('.custom-dropdown-header');

        // Abrir/cerrar con click
        activeHeader.addEventListener('click', (e) => {
            if (nativeSelect.disabled) return; // FIX: Respetar estado disabled
            e.preventDefault();
            e.stopPropagation();
            const isOpen = dropdown.classList.contains('open');
            if (!isOpen) {
                closeAllDropdowns(dropdown);
                dropdown.classList.add('open');
            } else {
                dropdown.classList.remove('open');
            }
        });

        // Soporte teclado
        activeHeader.addEventListener('keydown', (e) => {
            if (nativeSelect.disabled) return;
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                activeHeader.click();
            } else if (e.key === 'Escape' || e.key === 'Esc') {
                dropdown.classList.remove('open');
                activeHeader.blur();
            }
        });

        // Selección
        menu.querySelectorAll('.custom-option').forEach((option, index) => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // if (index === 0) return; // Permitir seleccionar el placeholder si es necesario (e.g. "Seleccioná...")
                
                const value = option.getAttribute('data-value');
                const text = option.textContent;
                
                nativeSelect.value = value;
                activeHeader.textContent = text;
                dropdown.classList.remove('open');
                
                // Disparar evento change manualmente
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            });
        });

        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });
    }

    // Inicializar todos los wrappers existentes al cargar
    document.querySelectorAll('.custom-select-wrapper').forEach(setupCustomDropdown);

    // --- Referencias ---
    const $esp = document.getElementById('especialidad');
    const $plant = document.getElementById('plantilla_id');
    const $inicio = document.getElementById('fecha_inicio');
    const $fin = document.getElementById('fecha_fin');
    const $form = document.getElementById('form-generador');
    const $btnStart = document.getElementById('btn-iniciar');
    const $btnReset = document.getElementById('btn-reset');
    const $panelEstado = document.getElementById('panel-estado');
    const $badge = document.getElementById('estado-badge');
    const $barra = document.getElementById('barra-progreso');
    const $msg = document.getElementById('estado-mensajes');
    const $ok = document.getElementById('resultado-ok');
    const $err = document.getElementById('resultado-error');
    const $errText = document.getElementById('error-text');
    const $linkVer = document.getElementById('link-ver');
    const $linkAnalisis = document.getElementById('link-analisis');
    const $warn = document.getElementById('form-warning');
    const $warnText = document.getElementById('form-warning-text');


    // --- Funciones de UI ---
    function setEstado(text, kind){
        $badge.className = 'badge bg-' + (kind || 'secondary');
        $badge.textContent = text;
    }
    
    let currentProgress = 0;
    function setProgreso(p, keepAnimated = true){ 
        const newVal = Math.max(currentProgress, p || 0);
        currentProgress = newVal;
        if($barra) {
            $barra.style.width = newVal + '%';
            $barra.setAttribute('aria-valuenow', newVal);
            if (!keepAnimated) {
                $barra.classList.remove('progress-bar-animated');
            } else {
                $barra.classList.add('progress-bar-animated');
            }
        }
    }
    
    function setMsg(html){ if($msg) $msg.innerHTML = html; }
    
    function hideWarn(){
        if ($warn) $warn.classList.add('d-none');
        if ($warnText) $warnText.textContent = '';
    }
    
    function showWarn(text){
        if ($warn && $warnText) {
            $warnText.textContent = text;
            $warn.classList.remove('d-none');
        }
    }
    
    function toggleLoading(on){
        if($btnStart) $btnStart.disabled = !!on;
        if($esp) $esp.disabled = !!on;
        if($plant) $plant.disabled = !!on;
        if($inicio) $inicio.disabled = !!on;
        if($fin) $fin.disabled = !!on;
        window.__generadorJobInProgress = !!on;
        
        // Actualizar visualmente los dropdowns custom si se deshabilitan
        document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
             const native = wrapper.querySelector('.form-select');
             const header = wrapper.querySelector('.custom-dropdown-header');
             if(native.disabled) header.style.backgroundColor = '#e9ecef';
             else header.style.backgroundColor = '#ffffff';
        });
    }
    
    function resetUI(){
        currentProgress = 0;
        setEstado('Listo','secondary'); setProgreso(0, false); setMsg('Completa el formulario y presioná "Iniciar optimización".');
        if($msg) $msg.classList.remove('d-none');
        if($ok) $ok.classList.add('d-none'); 
        if($err) $err.classList.add('d-none');
        if($btnReset) $btnReset.classList.add('d-none');
        if($panelEstado) $panelEstado.classList.add('d-none');
        if($warn) $warn.classList.add('d-none');
        toggleLoading(false);
        window.__generadorJobInProgress = false;
    }

    // Si la plantilla ya está en estado 'resultado-ok' (ej. render server-side
    // o visitante vuelve tras ejecución), mantenemos el estado completado y
    // bloqueamos el botón de iniciar. En caso contrario, reseteamos la UI.
    if($ok && !$ok.classList.contains('d-none')){
        if($panelEstado) $panelEstado.classList.remove('d-none');
        if($btnReset) $btnReset.classList.remove('d-none');
        if($btnStart) $btnStart.disabled = true;
        setEstado('Completado','success');
        setProgreso(100, false);
        if($msg) $msg.classList.add('d-none');
        window.__generadorJobInProgress = false;
        window.__generadorCompleted = true;
    } else {
        resetUI();
    }

    // --- Cargar plantillas al cambiar especialidad (CORREGIDO) ---
    if($esp) {
        $esp.addEventListener('change', async function(){
            if(!$plant) return;
            
            // 1. Resetear visualmente el dropdown de plantillas
            const plantWrapper = $plant.closest('.custom-select-wrapper');
            const plantHeader = plantWrapper ? plantWrapper.querySelector('.custom-dropdown-header') : null;
            const plantMenu = plantWrapper ? plantWrapper.querySelector('.custom-dropdown-menu') : null;

            // Poner estado "Cargando..."
            $plant.innerHTML = '<option value="" selected>Cargando...</option>';
            $plant.disabled = true;
            if (plantHeader) plantHeader.textContent = 'Cargando...';
            if (plantMenu) plantMenu.innerHTML = '<div class="custom-option" data-value="">Cargando...</div>';
            
            try {
                const resp = await fetch(`{% url 'api_get_plantillas' %}?especialidad=${encodeURIComponent($esp.value)}`);
                const data = await resp.json();
                const items = (data.plantillas || []);
                
                if(!items.length){
                    // Caso: No hay plantillas
                    $plant.innerHTML = '<option value="" selected>No hay plantillas disponibles</option>';
                    $plant.disabled = true;
                    if (plantHeader) plantHeader.textContent = 'No hay plantillas disponibles';
                    if (plantMenu) plantMenu.innerHTML = '<div class="custom-option" data-value="">No hay plantillas disponibles</div>';
                } else {
                    // Caso: Hay plantillas -> Generar opciones
                    const optionsHTML = '<option value="" selected>Seleccioná una plantilla</option>' + 
                                      items.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
                    $plant.innerHTML = optionsHTML;
                    $plant.disabled = false; // Habilitar select nativo

                    // Actualizar custom dropdown
                    if (plantHeader) plantHeader.textContent = 'Seleccioná una plantilla';
                    if (plantMenu) {
                        const customOptionsHTML = '<div class="custom-option" data-value="">Seleccioná una plantilla</div>' + 
                                                items.map(p=>`<div class="custom-option" data-value="${p.id}">${p.nombre}</div>`).join('');
                        plantMenu.innerHTML = customOptionsHTML;
                    }
                    
                    // IMPORTANTE: Re-inicializar listeners para las nuevas opciones
                    if (plantWrapper) setupCustomDropdown(plantWrapper);
                }
            } catch(e){
                console.error(e);
                $plant.innerHTML = '<option value="" selected>Error cargando plantillas</option>';
                $plant.disabled = true;
                if (plantHeader) plantHeader.textContent = 'Error cargando plantillas';
            }
        });
    }

    // --- Envío del formulario ---
    if($form) {
        $form.addEventListener('submit', async function(ev){
            ev.preventDefault();
            // Bloquear envío si ya existe una planificación generada
            if (window.__generadorCompleted || ($btnStart && $btnStart.disabled && !window.__generadorJobInProgress)){
                showWarn('Ya existe una planificación generada. Reiniciá para ejecutar de nuevo.');
                return;
            }
            if($warn) $warn.classList.add('d-none');

            const requiredChecks = [
                { el: $inicio, name: 'Fecha inicio' },
                { el: $fin, name: 'Fecha fin' },
                { el: $esp, name: 'Especialidad' },
                { el: $plant, name: 'Plantilla' }
            ];

            let missing = requiredChecks.filter(c => !c.el || !c.el.value || c.el.value.trim() === '');
            if (missing.length > 0) {
                showWarn('Por favor, completá todos los campos obligatorios (*)');
                return;
            }

            if($fin.value <= $inicio.value){
                showWarn('La fecha fin debe ser posterior a la fecha inicio.');
                return;
            }

            // Validar rango
            const fechaInicio = new Date($inicio.value);
            const fechaFin = new Date($fin.value);
            const diffTime = Math.abs(fechaFin - fechaInicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if(diffDays < 7){
                showWarn('El período a planificar debe ser de al menos 7 días.');
                return;
            }
            if(diffDays > 31){
                showWarn('El período a planificar no puede superar los 31 días.');
                return;
            }

            // Guardar duración del período para cálculos posteriores (estimados)
            window.__generador_period_days = diffDays;

            if($panelEstado) $panelEstado.classList.remove('d-none');
            toggleLoading(true);
            setEstado('Iniciando','primary');
            setProgreso(15);
            setMsg('Enviando parámetros al motor de optimización...');

            try {
                const resp = await fetch('{% url 'api_iniciar_planificacion' %}', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        fecha_inicio: $inicio.value,
                        fecha_fin: $fin.value,
                        especialidad: $esp.value,
                        plantilla_id: $plant.value
                    })
                });
                const data = await resp.json();
                
                if(!resp.ok){
                    if(resp.status === 422 && data.tipo_error === 'FALTA_DOTACION') {
                        mostrarErrorDotacion(data.detalles);
                        resetUI(); 
                        return;
                    }
                    throw new Error(data.error || 'Error al iniciar.');
                }

                setEstado('Ejecutando','primary');
                setProgreso(40);
                setMsg('<div class="d-flex align-items-center gap-2"><span class="spinner-border spinner-border-sm text-primary" role="status"></span><span>Algoritmo en ejecución. Este proceso puede tardar unos minutos...</span></div>');
                if($btnReset) $btnReset.classList.remove('d-none');

                await pollEstado(data.job_id);
            } catch(e){
                setEstado('Error','danger');
                setProgreso(0, false);
                if($msg) $msg.classList.add('d-none');
                if($errText) $errText.textContent = e.message || 'Error desconocido.';
                if($err) $err.classList.remove('d-none');
                toggleLoading(false);
            }
        });
    }

    // --- NAVIGATION / UNLOAD HANDLING ---
    // (Rest of your navigation handling code remains the same)
    let pendingNavigationAction = null;
    const navModalEl = document.getElementById('navigationConfirmModal');
    const navModal = navModalEl ? new bootstrap.Modal(navModalEl) : null;
    const confirmLeaveBtn = document.getElementById('confirmLeaveBtn');

    window.addEventListener('beforeunload', function(e){
        if (window.__generadorJobInProgress) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    document.addEventListener('click', function(e){
        if (!window.__generadorJobInProgress) return;
        const a = e.target.closest && e.target.closest('a');
        if (!a) return;
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || href.startsWith('javascript:')) return;
        if (a.hasAttribute('data-ignore-navigation')) return;
        e.preventDefault();
        pendingNavigationAction = { type: 'link', href: a.href };
        if (navModal) navModal.show();
    });

    if ($btnReset) {
        $btnReset.addEventListener('click', function(e){
            if (!window.__generadorJobInProgress) {
                resetUI();
                return;
            }
            e.preventDefault();
            pendingNavigationAction = { type: 'reset' };
            if (navModal) navModal.show();
        });
    }

    if (confirmLeaveBtn) {
        confirmLeaveBtn.addEventListener('click', function(){
            window.__generadorJobInProgress = false;
            if (navModal) navModal.hide();
            const action = pendingNavigationAction || { type: 'link', href: '/' };
            pendingNavigationAction = null;
            setTimeout(() => {
                if (action.type === 'link' && action.href) {
                    window.location.href = action.href;
                } else if (action.type === 'reset') {
                    resetUI();
                } else {
                    window.location.href = '/';
                }
            }, 120);
        });
    }

    async function pollEstado(jobId){
        let p = 40;
        const tick = setInterval(()=>{ p = Math.min(p+5, 90); setProgreso(p); }, 2000);
        
        try {
            while(true){
                // Replace JOBID placeholder properly
                const url = `{% url 'api_estado_planificacion' job_id='00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', jobId);
                const resp = await fetch(url);
                const data = await resp.json();
                
                if(data.status === 'completed'){
                    clearInterval(tick);
                    setEstado('Completado','success');
                    setProgreso(100, false);
                    if($msg) $msg.classList.add('d-none');
                    if($ok) $ok.classList.remove('d-none');
                    
                    const id = data.cronograma_id;
                    if($linkVer) $linkVer.href = `{% url 'ver_cronograma' cronograma_id=0 %}`.replace('/0/', `/${id}/`);
                    if($linkAnalisis) $linkAnalisis.href = `{% url 'cronograma_analisis' pk=0 %}`.replace('/0/', `/${id}/`);
                    
                    toggleLoading(false);
                    // Bloquear iniciar una nueva ejecución hasta reiniciar
                    if($btnStart) $btnStart.disabled = true;
                    window.__generadorCompleted = true;
                    break;
                } else if(data.status === 'running' || data.status === 'queued' || resp.status === 202){
                    // wait
                } else if(data.status === 'failed' || data.error){
                    throw new Error(data.error || 'Fallo en el proceso.');
                }
                await new Promise(r=>setTimeout(r, 2500));
            }
        } catch(e){
            clearInterval(tick);
            setEstado('Error','danger');
            setProgreso(0, false);
            if($msg) $msg.classList.add('d-none');
            if($errText) $errText.textContent = e.message || 'Error durante el seguimiento.';
            if($err) $err.classList.remove('d-none');
            toggleLoading(false);
        }
    }

});
</script>
{% endblock %}
