{% extends 'base.html' %}

{% block content %}
<div class="container py-2" style="max-width: 1400px;">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print border-bottom pb-3">
        <div>
            <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Análisis de Cronograma - {{ cronograma.get_especialidad_display }}</h1>
            <p class="text-muted fs-5 mb-0">{{ cronograma.fecha_inicio|date:"d/m/Y" }} al {{ cronograma.fecha_fin|date:"d/m/Y" }}</p>
        </div>

        <div class="d-flex gap-2 align-items-center">
            {% if cronograma.estado != 'FALLIDO' %}
                <a href="{% url 'exportar_pdf' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-2">
                    <i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF
                </a>
                <a href="{% url 'exportar_excel' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-3">
                    <i class="bi bi-file-earmark-excel-fill me-1"></i>Excel
                </a>

                <div>
                    <form id="form-toggle-publicado" method="post" style="display:inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="silent" id="silent_toggle" value="1">
                        <div class="form-check form-switch d-inline-flex align-items-center gap-2 switch-custom">
                            <input class="form-check-input" type="checkbox" id="togglePublicado" name="publicado" {% if cronograma.estado == 'PUBLICADO' %}checked{% endif %}>
                            <label class="form-check-label mb-0 fw-semibold" for="togglePublicado" style="color: #2f3e4c;">Publicado</label>
                        </div>
                    </form>
                </div>

                <!-- Publish/Unpublish confirmation modal (same as other cronograma views) -->
                <div class="modal fade" id="publishConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                            <div class="modal-header border-0 pb-0 pt-4 px-4" style="background: white;">
                                <button type="button" class="btn-close position-absolute" style="top: 16px; right: 16px; opacity: 0.5;" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center px-5 pb-4 pt-2">
                                <div class="mb-4">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0d6efd;">
                                        <i class="bi bi-exclamation-lg" style="font-size: 2rem; color: #0d6efd;"></i>
                                    </div>
                                </div>

                                <h4 class="fw-bold mb-3" style="color: #2f3e4c;">¿Estás seguro?</h4>

                                <div class="mb-3 p-4 text-center" style="background-color: #ffffff; border-radius: 10px; border: 1px solid #e0e5ec; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
                                    <p id="publishModalText" class="mb-0 small text-muted">Estas a punto de publicar/despublicar (según corresponda) este cronograma oficialmente</p>
                                </div>
                            </div>
                            <div class="modal-footer border-0 bg-white justify-content-center gap-2 pb-4">
                                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="border-radius: 10px; font-weight: 600; border: 1px solid #dee2e6; min-width: 140px;">Cancelar</button>
                                <button type="button" id="confirmPublishBtn" class="btn btn-primary px-4 py-2" style="border-radius: 10px; font-weight: 600; min-width: 140px;">Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <button disabled class="btn btn-outline-secondary fw-bold px-3 me-2" title="No se puede exportar un cronograma fallido">
                    <i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF
                </button>
                <button disabled class="btn btn-outline-secondary fw-bold px-3 me-3" title="No se puede exportar un cronograma fallido">
                    <i class="bi bi-file-earmark-excel-fill me-1"></i>Excel
                </button>

                <div>
                    <div class="form-check form-switch d-inline-flex align-items-center gap-2 switch-custom">
                        <input class="form-check-input" type="checkbox" id="togglePublicado" name="publicado" disabled>
                        <label class="form-check-label mb-0 fw-semibold" for="togglePublicado" style="color: #2f3e4c;">Publicado</label>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    {# --- Alerta General --- #}
    {% if cronograma.estado == 'FALLIDO' %}
    <div class="alert alert-danger d-flex align-items-center mb-4 shadow-sm" role="alert">
        <div>
            <h5 class="alert-heading fw-bold mb-1">Cronograma Rechazado por Normativa</h5>
            <p class="mb-0">
                La solución generada no cumple con los estándares mínimos de seguridad o cobertura. 
                Se recomienda revisar el reporte de incidentes para ver los detalles.
            </p>
        </div>
    </div>
    {% endif %}

    {% if cronograma.reporte_analisis.insights %}
    <div class="row mb-0">
        <div class="col-12">
            {% for insight in cronograma.reporte_analisis.insights %}
                    {% if insight.tipo == 'PATRON_DIA' %}
                    {% with day=insight.titulo|cut:"Cuello de Botella: " %}
                        <div class="alert alert-warning d-flex align-items-center mb-4 shadow-sm" role="alert">
                            <div>
                                <h5 class="alert-heading fw-bold mb-1">Cuello de Botella</h5>
                                <p class="mb-0" id="cuello-mensaje" data-day="{{ day }}" style="font-size: 0.98rem;">El 100% de los déficits ocurren los días {{ day }}. Se recomienda revisar ausencias y preferencias, o reforzar la dotación de profesionales para mejorar la cobertura de ese día.</p>
                            </div>
                        </div>
                    {% endwith %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mb-4 kpi-row">
        <div class="col-md-4">
            <div class="card mb-2 h-100 card-soft kpi-card">
                <div class="card-header bg-white border-bottom-0">Profesionales faltantes</div>
                <div class="card-body text-center">
                    {% with s=violaciones_duras.deficit_critico_senior|default:""|length c=violaciones_duras.deficit_cobertura|default:""|length p1=violaciones_blandas.preferencia_libre_incumplida|default:""|length p2=violaciones_blandas.preferencia_turno_incumplida|default:""|length %}
                        <div id="kpi-inrange" class="kpi-metric">{{ s|add:c|add:p1|add:p2 }}</div>
                    {% endwith %}
                    <div class="kpi-divider"></div>
                    <p class="card-text mb-0 small text-muted">Cantidad de profesionales faltantes</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-2 h-100 card-soft kpi-card">
                <div class="card-header bg-white border-bottom-0">Cobertura de Demanda</div>
                <div class="card-body text-center">
                    {% if violaciones_duras.deficit_critico_senior %}
                        <div class="text-danger mb-2 animate__animated animate__tada animate__infinite">
                            <i class="bi bi-x-circle-fill" style="font-size: 2.25rem;"></i>
                        </div>
                        <div class="kpi-status-title fw-bold text-danger">Cantidad insuficiente de Seniors</div>
                        <small class="text-muted">Varios turnos sin profesionales Seniors asignados.</small>
                    {% elif violaciones_duras.deficit_cobertura %}
                        <div class="text-warning mb-2">
                            <i class="bi bi-exclamation-triangle-fill" style="font-size: 2.25rem;"></i>
                        </div>
                        <div class="kpi-status-title fw-bold text-warning">Déficit Detectado</div>
                        <small class="text-muted">Cobertura insuficiente en algunos turnos.</small>
                    {% else %}
                        <div class="text-success mb-2">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.25rem;"></i>
                        </div>
                        <div class="kpi-status-title fw-bold text-success">Completa</div>
                        <small class="text-muted">Se cumplieron todas las reglas</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-2 h-100 card-soft kpi-card">
                <div class="card-header bg-white border-bottom-0">Promedio de Horas</div>
                <div class="card-body text-center">
                    <div class="kpi-metric">{{ equidad.promedio_objetivo|default:"-"|floatformat:1 }}</div>
                    <div class="kpi-divider"></div>
                    <p class="card-text mb-0 small text-muted">Horas promedio por profesional</p>
                </div>
            </div>
        </div>
    </div>
    
    

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-white fw-bold">Distribución de Horas por Profesional</div>
                <div class="card-body">
                    <div style="height: 400px; position: relative;">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-white fw-bold d-flex align-items-center justify-content-between">
                    <span><i class="bi bi-list-check me-2 text-primary"></i> Reporte de Incidentes</span>
                    {% if violaciones_duras.deficit_critico_senior or violaciones_duras.deficit_cobertura %}
                        <span class="badge badge-attention-blue">Atención Requerida</span>
                    {% endif %}
                </div>
                <div class="card-body p-0 overflow-auto" style="max-height: 500px;">
                    <ul class="list-group list-group-flush">
                        {% if violaciones_duras.deficit_critico_senior %}
                            {% for v in violaciones_duras.deficit_critico_senior %}
                                <li class="list-group-item list-group-item-danger bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="me-2">
                                            <div class="fw-bold text-danger mb-0">{{ v.turno }}</div>
                                            <small class="text-danger lh-1" style="font-size: 0.85rem;">{{ v.detalle }}</small>
                                        </div>
                                        <span class="badge rounded-pill bg-white text-muted border">{{ v.fecha|slice:"5:" }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        {% endif %}

                        {% if violaciones_duras.deficit_cobertura %}
                            {% for v in violaciones_duras.deficit_cobertura %}
                                {% if 'senior' not in v.detalle|lower %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="me-2">
                                            <div class="fw-bold text-dark mb-0">{{ v.turno }}</div>
                                            <small class="text-muted lh-1" style="font-size: 0.85rem;">{{ v.detalle }}</small>
                                        </div>
                                        <span class="badge rounded-pill bg-white text-muted border">{{ v.fecha|slice:"5:" }}</span>
                                    </div>
                                </li>
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {% if violaciones_blandas.preferencia_libre_incumplida %}
                            <li class="list-group-item bg-light fw-bold small text-uppercase text-muted border-bottom-0 mt-2">
                                <i class="bi bi-calendar-x me-1"></i> Francos No Respetados
                            </li>
                            {% for v in violaciones_blandas.preferencia_libre_incumplida %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="me-2">
                                            <div class="fw-bold text-dark mb-0">{{ v.nombre }}</div>
                                            <small class="text-muted lh-1" style="font-size: 0.85rem;">{{ v.detalle }}</small>
                                        </div>
                                        <span class="badge bg-white text-muted border">{{ v.fecha|slice:"5:" }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        {% endif %}

                        {% if violaciones_blandas.preferencia_turno_incumplida %}
                            <li class="list-group-item bg-light fw-bold small text-uppercase text-muted border-bottom-0 mt-2">
                                <i class="bi bi-clock-history me-1"></i> Preferencias Ignoradas
                            </li>
                            {% for v in violaciones_blandas.preferencia_turno_incumplida %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="me-2">
                                            <div class="fw-bold text-dark mb-0">{{ v.nombre }}</div>
                                            <small class="text-muted lh-1" style="font-size: 0.85rem;">{{ v.detalle }}</small>
                                        </div>
                                        <span class="badge bg-light text-muted border">{{ v.fecha|slice:"5:" }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        {% endif %}

                        {% if not violaciones_duras.deficit_critico_senior and not violaciones_duras.deficit_cobertura and not violaciones_blandas.preferencia_libre_incumplida and not violaciones_blandas.preferencia_turno_incumplida %}
                            <li class="list-group-item incidents-empty border-0">
                                <div class="incidents-empty-body d-flex flex-column align-items-center text-center text-muted w-100 py-4">
                                    <div class="incidents-empty-icon rounded-circle d-flex align-items-center justify-content-center mb-4" style="width:64px; height:64px;">
                                        <i class="bi bi-check-lg fs-3"></i>
                                    </div>
                                    <div class="fw-bold">Sin incidentes</div>
                                    <div class="small">El cronograma es óptimo.</div>
                                </div>
                            </li>
                        {% endif %}

                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{{ equidad.horas_por_profesional|default:None|json_script:"data-horas" }}
{{ equidad.nombres_cortos|default:None|json_script:"data-nombres-cortos" }}
{{ equidad.nombres_profesionales|default:None|json_script:"data-nombres-largos" }}
{{ equidad.limites_contractuales|default:None|json_script:"data-limites" }}
{{ equidad.rango_ideal|default:None|json_script:"data-rango-equidad" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        function getData(id, def) {
            const el = document.getElementById(id);
            if (!el) return def;
            const val = JSON.parse(el.textContent);
            return val === null ? def : val;
        }

        const ctxEl = document.getElementById('equityChart');
        if (!ctxEl) return;

        const horasReales = getData('data-horas', []);
        const nombresCortos = getData('data-nombres-cortos', []);
        const nombresLargos = getData('data-nombres-largos', []);     
        const limites = getData('data-limites', []); 

        let minVal = Math.min(...horasReales);
        if (limites.length > 0) {
            const minLimits = limites.map(l => l[0]);
            const minLimit = Math.min(...minLimits);
            if (minLimit < minVal && minLimit > 0) minVal = minLimit;
        }
        const roundedMin = Math.floor(minVal / 20) * 20;
        const startY = roundedMin > 20 ? (roundedMin - 20) : 0;

        new Chart(ctxEl.getContext('2d'), {
            type: 'bar',
            data: {
                labels: nombresCortos.length > 0 ? nombresCortos : horasReales.map((_, i) => `P${i+1}`),
                datasets: [
                    {
                        label: 'Rango Contractual',
                        data: limites, 
                        backgroundColor: 'rgba(0, 0, 0, 0.04)', 
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        borderSkipped: false,
                        barPercentage: 0.7,
                        grouped: false, 
                        order: 2 
                    },
                    {
                        label: 'Horas Asignadas',
                        data: horasReales,
                        backgroundColor: function(context) {
                            const idx = context.dataIndex;
                            const val = context.raw;
                            const range = limites[idx];
                            if (range && (val < range[0] || val > range[1])) {
                                return 'rgba(220, 53, 69, 0.8)'; 
                            }
                            return 'rgba(13, 110, 253, 0.8)'; 
                        },
                        barPercentage: 0.35, 
                        grouped: false,
                        order: 1 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                scales: {
                    y: {
                        min: startY,
                        ticks: { stepSize: 20 },
                        title: { display: true, text: 'Horas Totales' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        backgroundColor: 'rgba(33, 37, 41, 0.95)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        padding: 10,
                        cornerRadius: 6,
                        callbacks: {
                            title: function(ctx) { return nombresLargos[ctx[0].dataIndex]; },
                            label: function() { return null; },
                            afterBody: function(ctx) {
                                const idx = ctx[0].dataIndex;
                                const val = horasReales[idx];
                                const lim = limites[idx];
                                return [
                                    `Planificado: ${val} hs`,
                                    lim ? `Contrato: ${lim[0]}-${lim[1]} hs` : ''
                                ];
                            }
                        }
                    }
                }
            }
        });

            // KPI percentage removed: card now displays incident count (server-side)
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
    var el = document.getElementById('cuello-mensaje');
    if(!el) return;
    var day = el.getAttribute('data-day');
    if(!day) return;
    var html = el.innerHTML;
    var idx = html.indexOf(day);
    if(idx === -1) {
        var regex = new RegExp(day, 'i');
        var match = html.match(regex);
        if(!match) return;
        idx = match.index;
        day = match[0];
    }
    el.innerHTML = html.slice(0, idx) + '<strong class="cuello-day">' + day + '</strong>' + html.slice(idx + day.length);
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        var toggle = document.getElementById('togglePublicado');
        var form = document.getElementById('form-toggle-publicado');
        var publishModalEl = document.getElementById('publishConfirmModal');
        var publishModal = publishModalEl ? new bootstrap.Modal(publishModalEl) : null;
        var publishText = document.getElementById('publishModalText');
        var confirmPublishBtn = document.getElementById('confirmPublishBtn');

        if(!toggle || !form) return;

        var previousChecked = toggle.checked;

        toggle.addEventListener('change', function(e){
            var willPublish = this.checked;
            if (publishText) {
                publishText.textContent = willPublish
                    ? 'Estas a punto de publicar este cronograma oficialmente'
                    : 'Estas a punto de despublicar este cronograma oficialmente';
            }
            if (confirmPublishBtn) {
                confirmPublishBtn.textContent = willPublish ? 'Publicar' : 'Continuar';
                confirmPublishBtn.classList.remove('btn-danger');
                confirmPublishBtn.classList.add('btn-primary');
            }

            if (publishModal) {
                e.preventDefault();
                publishModal.show();
            } else {
                submitPublish(willPublish);
            }
        });

        function submitPublish(willPublish){
            var action = willPublish
                ? "{% url 'cronograma_publish' cronograma.id %}"
                : "{% url 'cronograma_unpublish' cronograma.id %}";

            var fd = new FormData(form);

            fetch(action, {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function(resp){
                if (resp.ok) {
                    previousChecked = toggle.checked;
                } else {
                    toggle.checked = previousChecked;
                    alert('No se pudo completar la acción. Intenta nuevamente.');
                }
            }).catch(function(){
                toggle.checked = previousChecked;
                alert('Error de red al intentar publicar/despublicar.');
            });
        }

        if (confirmPublishBtn) {
            confirmPublishBtn.addEventListener('click', function(){
                var desired = toggle.checked;
                if (publishModal) publishModal.hide();
                submitPublish(desired);
            });

            if (publishModalEl) {
                publishModalEl.addEventListener('hidden.bs.modal', function(){
                    if (toggle.checked === previousChecked) return;
                    toggle.checked = previousChecked;
                });
            }
        }
    });
</script>

<style>
    /* Harmonized styles copied from dashboard for consistent look */
    body { background-color: #edf1f7e2; }
    .card { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08) !important; border-radius: 12px; }
    .card-soft { border: none !important; background-color: #ffffff !important; }
    .kpi-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 0.75rem 1.25rem rgba(0,0,0,0.1) !important; }
    .kpi-card .card-header { font-weight: 700; text-transform: uppercase; font-size: 1rem; color: #5a5c69; padding: 0.6rem 1.25rem; }
    .kpi-metric { font-size: 2.2rem; font-weight: 800; color: #212529; }
    .kpi-divider { height: 2px; background: #e9ecef; margin: 0.6rem auto; border-radius: 2px; width: 60%; }
    .badge-status { display:inline-block; padding: 0.35rem 0.6rem; border-radius: 6px; font-weight:700; }
    .card-header.bg-white { background: #fff; }
    .list-group-item-danger.bg-opacity-10 { background-color: rgba(220,53,69,0.06); }
    .bg-warning.bg-opacity-25 { background-color: rgba(255,193,7,0.1) !important; }
    /* Switch sizing (same as other cronograma views) */
    .switch-custom .form-check-input {
        width: 3.5em;
        height: 1.75em;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
    .switch-custom .form-check-input:checked { background-color: var(--bs-primary); border-color: var(--bs-primary); }
    .switch-custom .form-check-label { cursor: pointer; user-select: none; font-size: 1.05rem; color: #2f3e4c; font-weight: 700; }
    /* Callout / policy-style card replaced by alert markup from preferencia_list.html */
    /* Incidents list - empty state and tip-style tweaks */
    .incidents-empty { background: transparent; }
    .incidents-empty .incidents-empty-icon { box-shadow: 0 0.5rem 0.75rem rgba(0,0,0,0.06); background-color: rgba(13,110,253,0.10); color: var(--bs-primary); }
    .list-group .incidents-empty { min-height: 320px; display: flex; align-items: center; justify-content: center; }
    .incidents-empty .incidents-empty-body { padding-top: 0; display: flex; flex-direction: column; align-items: center; }
    .incidents-empty .fw-bold { margin-top: 12px; font-size: 1rem; }
    .incidents-empty .small { margin-top: 4px; color: #6c757d; }
    /* Styled blue attention badge for incidents header */
    .badge-attention-blue { background: linear-gradient(180deg,#2b8cff,#0d6efd); color: #fff; padding: 0.35rem 0.75rem; border-radius: 999px; font-weight:700; box-shadow: 0 6px 18px rgba(13,110,253,0.12); }
    /* Emphasis for the 'day' inside the Cuello de Botella message */
    .cuello-day { color: #495057; font-weight:700; }
    /* Reduce gap between alert-cuello and KPI cards */
    .kpi-row { margin-top: -1rem !important; }
    /* KPI status title style kept consistent */
    .kpi-status-title { font-size: 1.05rem; margin-top: 0.35rem; }
</style>
{% endblock %}