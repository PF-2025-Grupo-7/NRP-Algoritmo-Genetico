{% extends "base.html" %}

{% block title %}Cronograma Detallado{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 no-print border-bottom pb-3">
    <div>
        <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Cronograma - {{ cronograma.get_especialidad_display }}</h1>
        <p class="text-muted fs-5 mb-0">{{ cronograma.fecha_inicio|date:"d/m/Y" }} al {{ cronograma.fecha_fin|date:"d/m/Y" }}</p>
    </div>

    <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'exportar_pdf' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-2">
            <i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF
        </a>
        <a href="{% url 'exportar_excel' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-3">
            <i class="bi bi-file-earmark-excel-fill me-1"></i>Excel
        </a>

        <div>
            <form id="form-toggle-publicado" method="post" style="display:inline-block;">
                {% csrf_token %}
                <input type="hidden" name="silent" id="silent_toggle" value="1">
                <div class="form-check form-switch d-inline-flex align-items-center gap-2 switch-custom">
                    <input class="form-check-input" type="checkbox" id="togglePublicado" name="publicado" {% if cronograma.estado == 'PUBLICADO' %}checked{% endif %}>
                    <label class="form-check-label mb-0 fw-semibold" for="togglePublicado" style="color: #2f3e4c;">Publicado</label>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="publishConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header border-0 pb-0 pt-4 px-4" style="background: white;">
                <button type="button" class="btn-close position-absolute" style="top: 16px; right: 16px; opacity: 0.5;" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center px-5 pb-4 pt-2">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0d6efd;">
                        <i class="bi bi-exclamation-lg" style="font-size: 2rem; color: #0d6efd;"></i>
                    </div>
                </div>
                <h4 class="fw-bold mb-3" style="color: #2f3e4c;">¿Estás seguro?</h4>
                <div class="mb-3 p-4 text-center" style="background-color: #ffffff; border-radius: 10px; border: 1px solid #e0e5ec; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
                    <p id="publishModalText" class="mb-2 fw-bold" style="color:#2f3e4c;">Estas a punto de publicar/despublicar (según corresponda) este cronograma oficialmente</p>
                    <p id="publishModalNote" class="mb-0 small" style="color:#6c757d;">La nueva regla se aplicará y la anterior se sobreescribirá.</p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-white justify-content-center gap-2 pb-4">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="border-radius: 10px; font-weight: 600; border: 1px solid #dee2e6; min-width: 140px;">Cancelar</button>
                <button type="button" id="confirmPublishBtn" class="btn btn-primary px-4 py-2" style="border-radius: 10px; font-weight: 600; min-width: 140px;">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        
        <div class="cronograma-legend d-flex align-items-center gap-3 no-print">
            <div class="d-flex gap-3 align-items-center w-100 flex-wrap">
                {% for turno in tipos_turno %}
                    {% with ab=turno.abreviatura %}
                        
                        {# DEFINICIÓN DE CLASES CSS Y ORDEN VISUAL #}
                        {# Variables: orden_visual (1=Claro, 2=Medio, 3=Oscuro) y clase_color #}
                        
                        {% if tipos_turno|length == 3 %}
                            {# --- LÓGICA DE 3 TURNOS --- #}
                            {% if tipos_turno.0.es_nocturno %}
                                {# Caso [N, A, B] -> N=Dark, A=Light, B=Medium #}
                                {% if forloop.counter0 == 0 %}<div class="d-none" data-cls="shift-dark" data-ord="3"></div>{% endif %}
                                {% if forloop.counter0 == 1 %}<div class="d-none" data-cls="shift-light" data-ord="1"></div>{% endif %}
                                {% if forloop.counter0 == 2 %}<div class="d-none" data-cls="shift-medium" data-ord="2"></div>{% endif %}
                            
                            {% elif tipos_turno.1.es_nocturno %}
                                {# Caso [A, N, B] -> N=Dark, B=Light, A=Medium #}
                                {% if forloop.counter0 == 1 %}<div class="d-none" data-cls="shift-dark" data-ord="3"></div>{% endif %}
                                {% if forloop.counter0 == 2 %}<div class="d-none" data-cls="shift-light" data-ord="1"></div>{% endif %}
                                {% if forloop.counter0 == 0 %}<div class="d-none" data-cls="shift-medium" data-ord="2"></div>{% endif %}
                            
                            {% elif tipos_turno.2.es_nocturno %}
                                {# Caso [A, B, N] -> N=Dark, A=Light, B=Medium #}
                                {% if forloop.counter0 == 2 %}<div class="d-none" data-cls="shift-dark" data-ord="3"></div>{% endif %}
                                {% if forloop.counter0 == 0 %}<div class="d-none" data-cls="shift-light" data-ord="1"></div>{% endif %}
                                {% if forloop.counter0 == 1 %}<div class="d-none" data-cls="shift-medium" data-ord="2"></div>{% endif %}
                            
                            {% else %}
                                {# FALLBACK: Ninguno es nocturno -> Orden cronológico puro #}
                                {# [A, B, C] -> A=Light, B=Medium, C=Dark #}
                                {% if forloop.counter0 == 0 %}<div class="d-none" data-cls="shift-light" data-ord="1"></div>{% endif %}
                                {% if forloop.counter0 == 1 %}<div class="d-none" data-cls="shift-medium" data-ord="2"></div>{% endif %}
                                {% if forloop.counter0 == 2 %}<div class="d-none" data-cls="shift-dark" data-ord="3"></div>{% endif %}
                            {% endif %}

                        {% elif tipos_turno|length == 2 %}
                            {# --- LÓGICA DE 2 TURNOS --- #}
                            {% if turno.es_nocturno %}
                                <div class="d-none" data-cls="shift-dark" data-ord="3"></div>
                            {% elif not tipos_turno.0.es_nocturno and not tipos_turno.1.es_nocturno %}
                                {# Fallback: Ninguno es nocturno #}
                                {% if forloop.counter0 == 0 %}<div class="d-none" data-cls="shift-light" data-ord="1"></div>{% endif %}
                                {% if forloop.counter0 == 1 %}<div class="d-none" data-cls="shift-dark" data-ord="3"></div>{% endif %}
                            {% else %}
                                {# Si hay un nocturno y yo no soy él, soy Light #}
                                <div class="d-none" data-cls="shift-light" data-ord="1"></div>
                            {% endif %}
                        {% else %}
                            {# 1 Turno #}
                            <div class="d-none" data-cls="shift-light" data-ord="1"></div>
                        {% endif %}

                        <div class="legend-item d-inline-flex align-items-center" 
                             title="{{ turno.nombre }}"
                             style="order: 
                                {% if tipos_turno|length == 3 %}
                                    {% if tipos_turno.0.es_nocturno %}
                                        {% if forloop.counter0 == 0 %}3{% elif forloop.counter0 == 1 %}1{% else %}2{% endif %}
                                    {% elif tipos_turno.1.es_nocturno %}
                                        {% if forloop.counter0 == 1 %}3{% elif forloop.counter0 == 2 %}1{% else %}2{% endif %}
                                    {% elif tipos_turno.2.es_nocturno %}
                                        {% if forloop.counter0 == 2 %}3{% elif forloop.counter0 == 0 %}1{% else %}2{% endif %}
                                    {% else %}
                                        {# Fallback #}
                                        {% if forloop.counter0 == 0 %}1{% elif forloop.counter0 == 1 %}2{% else %}3{% endif %}
                                    {% endif %}
                                {% elif tipos_turno|length == 2 %}
                                    {% if turno.es_nocturno %}3
                                    {% elif not tipos_turno.0.es_nocturno and not tipos_turno.1.es_nocturno %}
                                        {% if forloop.counter0 == 0 %}1{% else %}3{% endif %}
                                    {% else %}1{% endif %}
                                {% else %}1{% endif %};">
                            
                            <div class="legend-swatch 
                                {% if tipos_turno|length == 3 %}
                                    {% if tipos_turno.0.es_nocturno %}
                                        {% if forloop.counter0 == 0 %}shift-dark{% elif forloop.counter0 == 1 %}shift-light{% else %}shift-medium{% endif %}
                                    {% elif tipos_turno.1.es_nocturno %}
                                        {% if forloop.counter0 == 1 %}shift-dark{% elif forloop.counter0 == 2 %}shift-light{% else %}shift-medium{% endif %}
                                    {% elif tipos_turno.2.es_nocturno %}
                                        {% if forloop.counter0 == 2 %}shift-dark{% elif forloop.counter0 == 0 %}shift-light{% else %}shift-medium{% endif %}
                                    {% else %}
                                        {# Fallback #}
                                        {% if forloop.counter0 == 0 %}shift-light{% elif forloop.counter0 == 1 %}shift-medium{% else %}shift-dark{% endif %}
                                    {% endif %}
                                {% elif tipos_turno|length == 2 %}
                                    {% if turno.es_nocturno %}shift-dark
                                    {% elif not tipos_turno.0.es_nocturno and not tipos_turno.1.es_nocturno %}
                                        {% if forloop.counter0 == 0 %}shift-light{% else %}shift-dark{% endif %}
                                    {% else %}shift-light{% endif %}
                                {% else %}shift-light{% endif %}" 
                                aria-hidden="true">{{ ab }}</div>
                            
                            <div class="legend-label small text-muted ms-2">{{ turno.nombre }}</div>
                        </div>
                    {% endwith %}
                {% empty %}
                    <div class="legend-item d-inline-flex align-items-center">
                        <div class="legend-swatch bg-secondary bg-opacity-10 text-secondary">-</div>
                        <div class="legend-label small text-muted ms-2">Sin turnos definidos</div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="table-responsive" style="max-height: 80vh;">
            <table class="table table-bordered table-hover mb-0 text-center align-middle" style="font-size: 0.9rem;">
                <thead class="table-light sticky-top" style="z-index: 2;">
                    <tr>
                        <th class="sticky-col-start bg-light" style="min-width: 200px;">Profesional</th>
                        <th class="total-col" style="min-width: 60px;">Total</th>
                        {% for fecha in rango_fechas %}
                            <th style="min-width: 45px;" class="{% if fecha.weekday >= 5 or fecha.es_dificil %}weekend-col{% endif %}">
                                <div class="small fw-bold">{{ fecha|date:"D"|upper|slice:":2" }}</div>
                                <div>{{ fecha|date:"d" }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for fila in filas_tabla %}
                    <tr>
                        <td class="text-start sticky-col-start bg-white fw-bold text-truncate" style="max-width: 220px;">
                            <div class="d-flex align-items-center gap-2">
                                <div class="flex-grow-1 text-truncate">{{ fila.empleado.nombre_completo }}</div>
                                <span class="badge rounded-pill text-bg-light border ms-1" style="font-size: 0.65em;">
                                    {{ fila.empleado.get_experiencia_display|slice:":1" }}
                                </span>
                            </div>
                        </td>
                        
                        <td class="bg-light total-col">
                            <strong>{{ fila.stats.turnos }}</strong> <small class="text-muted">t</small>
                        </td>

                        {% for celda in fila.celdas %}
                            {% if celda.turno %}
                                {# LÓGICA DE COLOR APLICADA A LA CELDA (Réplica exacta de la leyenda) #}
                                <td class="p-1 text-center align-middle 
                                    {% if tipos_turno|length == 3 %}
                                        {% if tipos_turno.0.es_nocturno %}
                                            {% if celda.turno.id == tipos_turno.0.id %}shift-dark
                                            {% elif celda.turno.id == tipos_turno.1.id %}shift-light
                                            {% else %}shift-medium{% endif %}
                                        
                                        {% elif tipos_turno.1.es_nocturno %}
                                            {% if celda.turno.id == tipos_turno.1.id %}shift-dark
                                            {% elif celda.turno.id == tipos_turno.2.id %}shift-light
                                            {% else %}shift-medium{% endif %}
                                        
                                        {% elif tipos_turno.2.es_nocturno %}
                                            {% if celda.turno.id == tipos_turno.2.id %}shift-dark
                                            {% elif celda.turno.id == tipos_turno.0.id %}shift-light
                                            {% else %}shift-medium{% endif %}
                                        
                                        {% else %}
                                            {# Fallback: Orden 0=L, 1=M, 2=D #}
                                            {% if celda.turno.id == tipos_turno.0.id %}shift-light
                                            {% elif celda.turno.id == tipos_turno.1.id %}shift-medium
                                            {% else %}shift-dark{% endif %}
                                        {% endif %}

                                    {% elif tipos_turno|length == 2 %}
                                        {% if celda.turno.es_nocturno %}shift-dark
                                        {% elif not tipos_turno.0.es_nocturno and not tipos_turno.1.es_nocturno %}
                                            {# Fallback 2 turnos: 0=L, 1=D #}
                                            {% if celda.turno.id == tipos_turno.0.id %}shift-light{% else %}shift-dark{% endif %}
                                        {% else %}shift-light{% endif %}
                                    {% else %}
                                        shift-light
                                    {% endif %}">
                                    <span class="fw-bold">{{ celda.turno.abreviatura }}</span>
                                </td>
                            {% else %}
                                <td class="p-1 bg-light text-center align-middle"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* 1. ESTILOS DE VISUALIZACIÓN EN PANTALLA */
    :root{
        --accent-blue: #0d6efd;
        --muted-ink: #5a5c69;
        --card-radius: 12px;
        
        /* --- PALETA DE GRADIENTE AZUL --- */
        /* 1. CLARO (Siguiente a la noche o 1ro en lista) */
        --shift-light-bg: #bbdefb; 
        --shift-light-text: #06367a;
        
        /* 2. MEDIO (Restante o 2do en lista) */
        --shift-medium-bg: #42a5f5; 
        --shift-medium-text: #002171;

        /* 3. OSCURO (Nocturno o último en lista) */
        --shift-dark-bg: #1565c0;
        --shift-dark-text: #ffffff;
    }

    .sticky-col-start {
        position: sticky;
        left: 0;
        z-index: 3;
        border-right: 1px solid #e9ecef !important;
        background-color: #fff;
    }
    thead .sticky-col-start {
        z-index: 4 !important;
    }

    /* CLASES SEMÁNTICAS */
    .shift-light { background-color: var(--shift-light-bg) !important; color: var(--shift-light-text) !important; }
    .shift-medium { background-color: var(--shift-medium-bg) !important; color: var(--shift-medium-text) !important; }
    .shift-dark { background-color: var(--shift-dark-bg) !important; color: var(--shift-dark-text) !important; }

    .legend-swatch.shift-light { background-color: var(--shift-light-bg); color: var(--shift-light-text); }
    .legend-swatch.shift-medium { background-color: var(--shift-medium-bg); color: var(--shift-medium-text); }
    .legend-swatch.shift-dark { background-color: var(--shift-dark-bg); color: var(--shift-dark-text); }

    /* Otros estilos base */
    td.bg-warning.bg-opacity-10 { background-color: rgba(237, 208, 115, 0.5) !important; }
    td.bg-success.bg-opacity-10 { background-color: rgba(34, 167, 109, 0.318) !important; }
    td.bg-danger.bg-opacity-10 { background-color: rgba(220, 53, 70, 0.256) !important; }

    th.weekend-col { background-color: #e6e9ec; color: #5a5c69 !important; }
    th.weekend-col .small { color: #5a5c69 !important; }

    tbody tr:hover { background-color: #fbfdff; transform: translateY(0); }
    td { vertical-align: middle !important; }

    .table { border-collapse: collapse; }
    .table thead th:nth-child(3),
    .table tbody td:nth-child(3) {
        border-left: 4px solid rgba(0,0,0,0.10);
        padding-left: 1.05rem;
    }
    .table thead th.total-col, .table tbody td.total-col {
        padding-right: 1.2rem;
        background-color: #f7fbfd;
        border-right: 4px solid rgba(0,0,0,0.10);
    }
    .sticky-col-start { background-color: #f7fbfd !important; }
    .table tbody td.total-col { box-shadow: inset -6px 0 10px -8px rgba(0,0,0,0.05); }

    .cronograma-legend { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f3f5; background: #ffffff; }
    .legend-item { display: inline-flex; align-items: center; gap: 0.5rem; }
    .legend-swatch{ width: 32px; height: 32px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .cronograma-legend .legend-item + .legend-item { margin-left: 10px; }
    .legend-label { font-weight:600; color: #5a5c69; }

    .card { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08) !important; border-radius: var(--card-radius); }

    .switch-custom .form-check-input {
        width: 3.5em;
        height: 1.75em;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
    .switch-custom .form-check-input:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
    .switch-custom .form-check-label {
        cursor: pointer;
        user-select: none;
        font-size: 1.05rem;
        color: #2f3e4c;
        font-weight: 700;
    }

    @media print {
        @page { size: landscape; margin: 5mm; }
        header, footer, nav, .sidebar, .navbar, .no-print, .btn { display: none !important; }
        body { background-color: white !important; padding: 0 !important; margin: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .container, .container-fluid, .main-content, .card { width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; }
        .table-responsive { overflow: visible !important; max-height: none !important; }
        table { font-size: 9px !important; width: 100% !important; }
        th, td { padding: 2px !important; white-space: nowrap; }
        .sticky-col-start { position: static !important; border-right: 1px solid #dee2e6 !important; }
        tr { page-break-inside: avoid; }
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        var toggle = document.getElementById('togglePublicado');
        var form = document.getElementById('form-toggle-publicado');
        var publishModalEl = document.getElementById('publishConfirmModal');
        var publishModal = publishModalEl ? new bootstrap.Modal(publishModalEl) : null;
        var publishText = document.getElementById('publishModalText');
        var confirmPublishBtn = document.getElementById('confirmPublishBtn');

        if(!toggle || !form) return;
        var previousChecked = toggle.checked;

        toggle.addEventListener('change', function(e){
            var willPublish = this.checked;
            if (publishText) {
                publishText.textContent = willPublish
                    ? 'Estas a punto de publicar este cronograma oficialmente'
                    : 'Estas a punto de despublicar este cronograma oficialmente';
            }
            if (confirmPublishBtn) {
                confirmPublishBtn.textContent = willPublish ? 'Publicar' : 'Continuar';
                confirmPublishBtn.classList.remove('btn-danger');
                confirmPublishBtn.classList.add('btn-primary');
            }
            if (publishModal) {
                e.preventDefault();
                publishModal.show();
            } else {
                submitPublish(willPublish);
            }
        });

        function submitPublish(willPublish){
            var action = willPublish
                ? "{% url 'cronograma_publish' cronograma.id %}"
                : "{% url 'cronograma_unpublish' cronograma.id %}";

            var fd = new FormData(form);

            fetch(action, {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function(resp){
                if (resp.ok) {
                    previousChecked = toggle.checked;
                } else {
                    toggle.checked = previousChecked;
                    alert('No se pudo completar la acción. Intenta nuevamente.');
                }
            }).catch(function(){
                toggle.checked = previousChecked;
                alert('Error de red al intentar publicar/despublicar.');
            });
        }

        if (confirmPublishBtn) {
            confirmPublishBtn.addEventListener('click', function(){
                var desired = toggle.checked;
                if (publishModal) publishModal.hide();
                submitPublish(desired);
            });

            if (publishModalEl) {
                publishModalEl.addEventListener('hidden.bs.modal', function(){
                    if (toggle.checked === previousChecked) return; 
                    toggle.checked = previousChecked;
                });
            }
        }
    });
</script>
{% endblock %}