<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Cronograma</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 0.8cm;
            @bottom-right {
                content: "Pág. " counter(page) " de " counter(pages);
                font-size: 9px; color: #666;
            }
        }
        
        body { font-family: 'Helvetica', sans-serif; color: #333; }
        
        /* Header */
        .header { 
            border-bottom: 2px solid #000; 
            padding-bottom: 8px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .titulo-principal { font-size: 18px; font-weight: 800; color: #333; margin: 0; }
        .subtitulo { font-size: 11px; color: #555; margin-top: 2px; }
        .meta-info { font-size: 9px; color: #777; text-align: right; margin-top: 5px; }

        /* Tablas */
        table { 
            width: 100%; border-collapse: collapse; 
               font-size: 8px; table-layout: fixed; 
        }
        th, td { 
               border: 1px solid #ccc; padding: 2px 3px; 
               text-align: center; vertical-align: middle; height: 18px;
        }
        th { background-color: #f8f9fb; color: #333; font-weight: 700; }
        
        th.col-nombre, td.col-nombre { 
            width: 120px; text-align: left; padding-left: 5px; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        th.finde, td.finde { background-color: #fafafa; }

        /* (no circular badges) full-cell coloring is used for schedule */

            /* Cells colored to fill entire TD for PDF: avoid border-radius/padding that overflow in WeasyPrint */
            td.shift-cell { font-weight: 700; padding: 0; overflow: hidden; vertical-align: middle; text-align: center; }

            /* Blue palette (mapped by index) */
            td.bg-0.shift-cell { background-color: #CBE7F3; color: #0D3558; } /* light celeste */
            td.bg-1.shift-cell { background-color: #6EA8E8; color: #0D3558; } /* medium blue */
            td.bg-2.shift-cell { background-color: #2C6FB0; color: #ffffff; } /* dark blue */
            td.bg-G.shift-cell { background-color: #D2E4FF; color: #0D47A1; }
            td.bg-X.shift-cell { background-color: #EBEBEB; color: #495057; }

        /* Subtle background tones and text colors to match on-screen (fallback classes) */
        .bg-M { background-color: #fff8e1; color: #997404; }
        .bg-T { background-color: #e6f7ee; color: #1f7a53; }
        .bg-N { background-color: #fff0f2; color: #dc3545; }
        .bg-G { background-color: #e9f0ff; color: #0d6efd; }
        .bg-X { background-color: #f1f1f1; color: #6c757d; }

        .page-break { page-break-before: always; }
        
        /* Referencias */
        .ref-item { display: inline-flex; align-items: center; margin-right: 14px; font-size: 10px; color: #555; margin-top:6px; }
        .ref-badge { display: inline-block; padding: 2px 6px; min-width:14px; height:18px; line-height:14px; border-radius:8px; font-weight:700; font-size:9px; margin-right:6px; }
        .references { margin-top: 12px; padding-top: 6px; border-top: 1px dotted #ccc; }
        .refs { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; align-items:center; }

        /* Legend badge colors mapped to index-based classes (same palette as table cells) */
        .ref-badge.bg-0 { background-color: #CBE7F3; color: #0D3558; }
        .ref-badge.bg-1 { background-color: #6EA8E8; color: #0D3558; }
        .ref-badge.bg-2 { background-color: #2C6FB0; color: #ffffff; }
        .ref-badge.bg-G { background-color: #D2E4FF; color: #0D47A1; }
        .ref-badge.bg-X { background-color: #EBEBEB; color: #495057; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 class="titulo-principal">Planificación de Guardias</h1>
            <div class="subtitulo">
                {{ cronograma.get_especialidad_display }} | {{ cronograma.fecha_inicio|date:"d/m/Y" }} al {{ cronograma.fecha_fin|date:"d/m/Y" }}
            </div>
        </div>
        <div class="meta-info">
            <div><strong>Creado:</strong> {{ cronograma.fecha_creacion|date:"d/m/Y H:i" }}</div>
            <div><strong>Impreso:</strong> {{ fecha_impresion|date:"d/m/Y H:i" }}</div>
            <div>Ref: #{{ cronograma.id }}</div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-nombre">Profesional</th>
                {% for dia in dias_encabezado %}
                    <th class="{% if dia.letra == 'S' or dia.letra == 'D' %}finde{% endif %}">
                        {{ dia.letra }}<br>{{ dia.dia_num }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for fila in filas %}
            <tr>
                <td class="col-nombre"><strong>{{ fila.empleado.nombre_corto }}</strong></td>
                
                {% for celda in fila.celdas %}
                    {% if celda %}
                                {% with ct=celda.tipo_turno %}
                                    {% for turno_def in tipos_turno %}
                                        {% if turno_def.id == ct.id %}
                                            <td class="bg-{{ forloop.counter0 }} shift-cell">{{ turno_def.abreviatura|default:turno_def.nombre|slice:":1" }}</td>
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="references">
        <strong>Referencias:</strong>
        <div class="refs">
        {% for turno in tipos_turno %}
            <div class="ref-item">
                <span class="ref-badge bg-{{ forloop.counter0 }}">{{ turno.abreviatura|default:turno.nombre|slice:":1" }}</span>
                <span style="margin-left:6px; color:#555;">{{ turno.nombre }}</span>
            </div>
        {% endfor %}
        </div>
    </div>

    <div class="page-break"></div>

    <h3>Análisis de Carga Horaria</h3>
    <table>
        <thead>
            <tr>
                <th class="text-start" style="width: 200px;">Profesional</th>
                <th>Horas Asignadas</th>
                <th>Objetivo</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for fila in filas %}
            <tr>
                <td class="text-start">{{ fila.empleado.nombre_completo }}</td>
                <td>{{ fila.horas_totales }} hs</td>
                <td>{{ fila.horas_min|floatformat:0 }} - {{ fila.horas_max|floatformat:0 }}</td>
                <td>
                    {% if fila.horas_totales < fila.horas_min %}
                        <span style="color:#dc3545;">Subasignado</span>
                    {% elif fila.horas_totales > fila.horas_max %}
                        <span style="color:#dc3545;">Sobreasignado</span>
                    {% else %}
                        <span style="color:#198754;">Óptimo</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>