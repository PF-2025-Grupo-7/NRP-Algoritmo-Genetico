<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Cronograma</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 0.8cm;
            @bottom-right {
                content: "Pág. " counter(page) " de " counter(pages);
                font-size: 9px; color: #666;
            }
        }
        
        body { font-family: 'Helvetica', sans-serif; color: #333; }
        
        /* Header */
        .header { 
            border-bottom: 2px solid #0d6efd; 
            padding-bottom: 10px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .titulo-principal { font-size: 18px; font-weight: bold; color: #0d6efd; margin: 0; }
        .subtitulo { font-size: 11px; color: #555; margin-top: 2px; }
        .meta-info { font-size: 9px; color: #777; text-align: right; margin-top: 5px; }

        /* Tablas */
        table { 
            width: 100%; border-collapse: collapse; 
            font-size: 9px; table-layout: fixed; 
        }
        th, td { 
            border: 1px solid #ccc; padding: 3px 1px; 
            text-align: center; vertical-align: middle; height: 18px;
        }
        th { background-color: #f1f3f5; color: #333; font-weight: bold; }
        
        th.col-nombre, td.col-nombre { 
            width: 140px; text-align: left; padding-left: 5px; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        th.finde, td.finde { background-color: #fafafa; }

        /* BADGES */
        .turno-badge { 
            display: block; margin: 0 auto;
            width: 16px; height: 16px; line-height: 16px; 
            border-radius: 50%; 
            color: white; font-weight: bold; font-size: 8px;
            text-transform: uppercase;
        }

        /* Colores basados en clases auxiliares */
        .bg-M { background-color: #ffc107; color: #000; border: 1px solid #e0a800; }
        .bg-T { background-color: #fd7e14; border: 1px solid #e86b02; }
        .bg-N { background-color: #0d6efd; border: 1px solid #0a58ca; }
        .bg-G { background-color: #198754; border: 1px solid #146c43; } /* Verde para Guardia */
        .bg-X { background-color: #6c757d; border: 1px solid #555; } /* Default */

        .page-break { page-break-before: always; }
        
        /* Referencias */
        .ref-item { display: inline-block; margin-right: 15px; font-size: 9px; color: #555; }
        .ref-badge { display: inline-block; width: 10px; height: 10px; line-height: 10px; margin-right: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 class="titulo-principal">Planificación de Guardias</h1>
            <div class="subtitulo">
                {{ cronograma.get_especialidad_display }} | {{ cronograma.fecha_inicio|date:"d/m/Y" }} al {{ cronograma.fecha_fin|date:"d/m/Y" }}
            </div>
        </div>
        <div class="meta-info">
            <div><strong>Creado:</strong> {{ cronograma.fecha_creacion|date:"d/m/Y H:i" }}</div>
            <div>Ref: #{{ cronograma.id }}</div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-nombre">Profesional</th>
                {% for dia in dias_encabezado %}
                    <th class="{% if dia.letra == 'S' or dia.letra == 'D' %}finde{% endif %}">
                        {{ dia.letra }}<br>{{ dia.dia_num }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for fila in filas %}
            <tr>
                <td class="col-nombre"><strong>{{ fila.empleado.nombre_corto }}</strong></td>
                
                {% for celda in fila.celdas %}
                    <td>
                        {% if celda %}
                            {% with nombre=celda.tipo_turno.nombre %}
                                {% if "Mañana" in nombre %}
                                    <span class="turno-badge bg-M">M</span>
                                {% elif "Tarde" in nombre %}
                                    <span class="turno-badge bg-T">T</span>
                                {% elif "Noche" in nombre %}
                                    <span class="turno-badge bg-N">N</span>
                                {% elif "Guardia" in nombre %}
                                    <span class="turno-badge bg-G">G</span>
                                {% else %}
                                    <span class="turno-badge bg-X">{{ nombre|slice:":1" }}</span>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 15px; padding-top: 5px; border-top: 1px dotted #ccc;">
        <strong>Referencias:</strong><br>
        {% for turno in tipos_turno %}
            <span class="ref-item">
                {% with n=turno.nombre %}
                    {% if "Mañana" in n %}
                        <span class="turno-badge ref-badge bg-M">M</span>
                    {% elif "Tarde" in n %}
                        <span class="turno-badge ref-badge bg-T">T</span>
                    {% elif "Noche" in n %}
                        <span class="turno-badge ref-badge bg-N">N</span>
                    {% elif "Guardia" in n %}
                        <span class="turno-badge ref-badge bg-G">G</span>
                    {% else %}
                        <span class="turno-badge ref-badge bg-X">{{ n|slice:":1" }}</span>
                    {% endif %}
                    {{ n }} {% endwith %}
            </span>
        {% endfor %}
    </div>

    <div class="page-break"></div>

    <h3>Análisis de Carga Horaria</h3>
    <table>
        <thead>
            <tr>
                <th class="text-start" style="width: 200px;">Profesional</th>
                <th>Horas Asignadas</th>
                <th>Objetivo</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for fila in filas %}
            <tr>
                <td class="text-start">{{ fila.empleado.nombre_completo }}</td>
                <td>{{ fila.horas_totales }} hs</td>
                <td>{{ fila.horas_min|floatformat:0 }} - {{ fila.horas_max|floatformat:0 }}</td>
                <td>
                    {% if fila.horas_totales < fila.horas_min %}
                        <span style="color:#dc3545;">Subasignado</span>
                    {% elif fila.horas_totales > fila.horas_max %}
                        <span style="color:#dc3545;">Sobreasignado</span>
                    {% else %}
                        <span style="color:#198754;">Óptimo</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>