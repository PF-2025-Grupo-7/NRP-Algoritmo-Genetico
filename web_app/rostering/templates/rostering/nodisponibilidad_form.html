{% extends 'base.html' %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Nueva ausencia</h1>
            <p class="text-muted fs-5 mb-0">Gestión de ausencias o no disponibilidad del personal</p>
        </div>
    </div>

    <style>
    .form-control, .form-select {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: #ffffff;
        color: #2f3e4c;
    }
    .form-select.d-none { display: none !important; }
    .form-control::placeholder {
        color: #6c757d;
        font-style: normal;
        font-weight: 400;
        opacity: 1;
    }
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        background-color: #f8fbff;
        outline: none;
    }
    .form-control:hover { background-color: #f5f7fb; }
    .form-control:disabled, .form-select:disabled {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.7;
    }
    .form-label { font-size: 0.95rem; margin-bottom: 0.5rem; color: #2f3e4c; letter-spacing: 0.3px; }
    .form-group { display: flex; flex-direction: column; }
    .custom-select-wrapper { position: relative; display: inline-block; width: 100%; }
    .custom-dropdown { position: relative; pointer-events: auto; }
    .custom-dropdown-header {
        height: 46px; border-radius: 10px; border: 1px solid #e0e5ec; background-color: #ffffff;
        padding: 12px 16px; font-size: 0.95rem; color: #495057; display: flex; align-items: center;
        transition: all 0.2s ease; cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; pointer-events: auto; min-width: 100%;
    }
    .custom-dropdown-header.is-invalid {
        border-color: #c41c3b !important;
        color: #c41c3b !important;
        box-shadow: 0 0 0 0.15rem rgba(196,28,59,0.15);
    }
    .custom-dropdown-header:hover { background-color: #f5f7fb; }
    .custom-dropdown-header.disabled{ opacity:0.6; cursor:not-allowed; pointer-events:none; }
    .custom-dropdown-menu {
        position: absolute; top: 100%; left: 0; right: 0; background-color: #ffffff; border: none;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); border-radius: 10px; max-height: 0; overflow: hidden;
        transition: max-height 0.3s ease; pointer-events: none; z-index: 100; margin-top: 0; padding: 0;
    }
    .custom-dropdown.open .custom-dropdown-menu { max-height: 300px; pointer-events: auto; opacity: 1; margin-top: 0.5rem; padding: 0.5rem 0; }
    .custom-option { padding: 0.5rem 1.2rem; color: #495057; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; border-bottom: none; font-weight: 500; }
    .custom-option:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; padding-left: 1.4rem; }
    .custom-option:first-child { background-color: transparent; color: #495057; font-weight: 500; cursor: pointer; }
    .custom-option:first-child:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; padding-left: 1.4rem; }
    .form-select:disabled ~ .custom-dropdown .custom-dropdown-header { background-color: #f5f5f5; border-color: #e0e5ec; opacity: 0.6; cursor: not-allowed; }
    .field-error { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 1rem; color: #c41c3b; font-size: 0.9rem; font-weight: 500; }
    .field-error i { font-size: 1rem; }
    .required-asterisk { color: #dc3545; margin-left: 0.25rem; font-weight: 700; }
    .btn { border-radius: 8px; font-size: 0.95rem; padding: 0.625rem 1.25rem; transition: all 0.3s ease; font-weight: 600; letter-spacing: 0.2px; }
    .btn i { margin-right: 0.3rem; }
    .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
    .btn-primary:hover { background-color: #0b5ed7; border-color: #0b5ed7; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3); }
    .btn-primary:active { transform: translateY(0); }
    .btn-outline-secondary { color: #6c757d; border-color: #6c757d; }
    .btn-outline-secondary:hover { background-color: #6c757d; border-color: #6c757d; color: white; transform: translateY(-2px); }
    @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .card { animation: slideInDown 0.3s ease; }
    @media (max-width: 768px) { .card-body { padding: 1.5rem !important; } h1 { font-size: 1.5rem !important; } .btn { padding: 0.5rem 1rem; font-size: 0.9rem; } .form-control, .form-select { padding: 0.625rem 0.875rem; font-size: 0.9rem; } .custom-dropdown-header { height: 42px; font-size: 0.9rem; padding: 10px 14px; padding-right: 36px; } }
    </style>
    <div class="card border-0" style="border-radius: 14px;">
        <div class="card-body p-4 p-lg-5">
            <form method="post" id="form-nodisponibilidad" novalidate autocomplete="off">
                {% csrf_token %}
                <div id="form-warning" class="field-error d-none" style="margin-bottom: 1.5rem;">
                    <i class="bi bi-exclamation-circle"></i>
                    <span id="form-warning-text"></span>
                </div>
                {% if form.non_field_errors %}
                    <div id="server-errors" class="field-error mb-4">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>{{ form.non_field_errors|join:", " }}</span>
                    </div>
                {% endif %}
                <div class="row g-3 mb-4">
                        <div class="col-12">
                        <div class="form-group">
                            <label class="form-label fw-bold" for="input_legajo">Datos Personales<span class="required-asterisk" aria-hidden="true">*</span></label>
                                <input type="text" id="input_legajo" name="legajo" class="form-control {% if form.instance.empleado %}disabled{% endif %}" placeholder="Ingresá legajo, nombre o especialidad del empleado" autocomplete="off" required
                                    value="{% if form.instance.empleado %}{{ form.instance.empleado.legajo }} - {{ form.instance.empleado.nombre_completo }}{% else %}{{ form.initial.legajo|default:'' }}{% endif %}"
                                    {% if form.instance.empleado %}disabled aria-disabled="true"{% endif %}>
                                <input type="hidden" id="id_empleado" name="empleado" required value="{% if form.instance.empleado %}{{ form.instance.empleado.pk }}{% else %}{{ form.initial.empleado|default:'' }}{% endif %}" data-especialidad="{% if form.instance.empleado %}{{ form.instance.empleado.especialidad }}{% else %}{{ form.initial.especialidad|default:'' }}{% endif %}">
                        </div>
                    </div>
                    
                </div>
                <div class="row g-3 mb-4">
                            <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-bold" for="id_fecha_inicio">Fecha inicio<span class="required-asterisk" aria-hidden="true">*</span></label>
                            <input type="date" id="id_fecha_inicio" name="fecha_inicio" class="form-control" required value="{% if form.instance.fecha_inicio %}{{ form.instance.fecha_inicio|date:'Y-m-d' }}{% else %}{{ form.initial.fecha_inicio|default:'' }}{% endif %}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-bold" for="id_fecha_fin">Fecha fin<span class="required-asterisk" aria-hidden="true">*</span></label>
                            <input type="date" id="id_fecha_fin" name="fecha_fin" class="form-control" required value="{% if form.instance.fecha_fin %}{{ form.instance.fecha_fin|date:'Y-m-d' }}{% else %}{{ form.initial.fecha_fin|default:'' }}{% endif %}">
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <!-- Eliminado label duplicado -->
                                <label class="form-label fw-bold" for="id_tipo_turno">Turno<span class="required-asterisk" aria-hidden="true">*</span></label>
                            <div class="custom-select-wrapper">
                                <select class="form-select d-none" id="id_tipo_turno" name="tipo_turno" required>
                                    <option value="" {% if not form.instance.tipo_turno and not form.initial.tipo_turno %}selected{% endif %}>Todo el día</option>
                                    {% for turno in form.fields.tipo_turno.queryset.all %}
                                        <option value="{{ turno.pk }}" data-especialidad="{{ turno.especialidad }}" {% if form.instance.tipo_turno and form.instance.tipo_turno.pk == turno.pk %}selected{% endif %}>{{ turno.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="custom-dropdown">
                                    <div class="custom-dropdown-header" tabindex="0">{% if form.instance.tipo_turno %}{{ form.instance.tipo_turno.nombre }}{% elif form.initial.tipo_turno %}{{ form.initial.tipo_turno }}{% else %}Seleccioná un turno{% endif %}</div>
                                    <div class="custom-dropdown-menu">
                                        <div class="custom-option" data-value="">Todo el día</div>
                                        {% for turno in form.fields.tipo_turno.queryset.all %}
                                            <div class="custom-option" data-value="{{ turno.pk }}" data-especialidad="{{ turno.especialidad }}">{{ turno.nombre }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label fw-bold" for="id_motivo">Motivo</label>
                            {{ form.motivo }}
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="#" onclick="window.history.back(); return false;" class="btn btn-outline-secondary fw-bold px-4 me-md-2">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary fw-bold px-4">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Definir setupCustomDropdown antes de usarla
function setupCustomDropdown(wrapper){
    const nativeSelect = wrapper.querySelector('.form-select');
    const header = wrapper.querySelector('.custom-dropdown-header');
    const dropdown = wrapper.querySelector('.custom-dropdown');
    const menu = wrapper.querySelector('.custom-dropdown-menu');
    if (!header || !dropdown || !menu || !nativeSelect) return;

    // Inicializar header con el valor seleccionado o placeholder
    try {
        const sel = nativeSelect.options[nativeSelect.selectedIndex];
        if (sel && sel.textContent && nativeSelect.value) {
            header.textContent = sel.textContent;
        }
    } catch (e) {}

    header.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        // don't open if native select is disabled
        if (nativeSelect.disabled) return;
        document.querySelectorAll('.custom-dropdown.open').forEach(d => { if(d !== dropdown) d.classList.remove('open'); });
        dropdown.classList.toggle('open');
    };

    menu.querySelectorAll('.custom-option').forEach((option, index) => {
        option.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            // ignore clicks when option hidden or select disabled
            if (nativeSelect.disabled) return;
            if (option.style.display === 'none') return;
            // Permitir seleccionar el placeholder ("Todo el día")
            const value = option.getAttribute('data-value');
            const text = option.textContent;
            nativeSelect.value = value;
            header.textContent = text;
            dropdown.classList.remove('open');
            nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        };
    });

    document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) dropdown.classList.remove('open'); });
}

document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('form-nodisponibilidad');
    const serverErrors = document.getElementById('server-errors');
    // Inicializar custom dropdowns
    document.querySelectorAll('.custom-select-wrapper').forEach(setupCustomDropdown);

    form.addEventListener('submit', function(e) {
        // Ocultar warning previo
        const warningDiv = document.getElementById('form-warning');
        const warningText = document.getElementById('form-warning-text');
        if (warningDiv) warningDiv.classList.add('d-none');
        if (serverErrors) serverErrors.classList.add('d-none');

        // Validar campos obligatorios (legajo/empleado, fecha_inicio, fecha_fin, tipo_turno)
        const requiredFields = [
            { field: document.getElementById('input_legajo'), name: 'Empleado' },
            { field: document.getElementById('id_empleado'), name: 'EmpleadoID' },
            { field: document.getElementById('id_fecha_inicio'), name: 'Fecha inicio' },
            { field: document.getElementById('id_fecha_fin'), name: 'Fecha fin' }
        ];
        let emptyFields = requiredFields.filter(item => !item.field.value || item.field.value.trim() === '');

        // Validar turno: solo marcar como inválido si el select está deshabilitado o no existe (no si es "Todo el día")
        var turnoField = document.getElementById('id_tipo_turno');
        var turnoWrapper = turnoField ? turnoField.closest('.custom-select-wrapper') : null;
        var turnoHeader = turnoWrapper ? turnoWrapper.querySelector('.custom-dropdown-header') : null;
        var turnoValue = turnoField ? turnoField.value : '';

        // Motivo: not required

        // Si hay campos vacíos, mostrar warning y marcar
        if (emptyFields.length > 0) {
            e.preventDefault();
            if (warningText) warningText.textContent = 'Por favor, completá todos los campos obligatorios (*)';
            if (warningDiv) {
                warningDiv.classList.remove('d-none');
                warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            emptyFields.forEach(function(item) {
                item.field.classList.add('is-invalid');
                item.field.addEventListener('input', function handler() {
                    item.field.classList.remove('is-invalid');
                    item.field.removeEventListener('input', handler);
                });
                // Si el campo es un select personalizado, marcar el header también
                if (item.field.classList.contains('form-select')) {
                    var wrapper = item.field.closest('.custom-select-wrapper');
                    if (wrapper) {
                        var header = wrapper.querySelector('.custom-dropdown-header');
                        if (header) {
                            header.classList.add('is-invalid');
                            item.field.addEventListener('change', function handler2() {
                                header.classList.remove('is-invalid');
                                item.field.removeEventListener('change', handler2);
                            });
                        }
                    }
                }
            });
            return;
        }

        // Validar que la fecha fin no sea menor que la fecha inicio
        var fechaInicio = document.getElementById('id_fecha_inicio').value;
        var fechaFin = document.getElementById('id_fecha_fin').value;
        if (fechaInicio && fechaFin) {
            var inicioDate = new Date(fechaInicio);
            var finDate = new Date(fechaFin);
            if (finDate < inicioDate) {
                e.preventDefault();
                if (warningText) warningText.textContent = 'La fecha fin no puede ser anterior a la fecha inicio.';
                if (warningDiv) {
                    warningDiv.classList.remove('d-none');
                    warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                var finField = document.getElementById('id_fecha_fin');
                finField.classList.add('is-invalid');
                finField.addEventListener('input', function handler() {
                    finField.classList.remove('is-invalid');
                    finField.removeEventListener('input', handler);
                });
                return;
            }
        }

        // Si el select de turno está presente y deshabilitado, o el header muestra 'Seleccioná un turno', marcar como inválido
        if (turnoField && (turnoField.disabled || (turnoHeader && turnoHeader.textContent.trim() === 'Seleccioná un turno'))) {
            if (turnoHeader) turnoHeader.classList.add('is-invalid');
            turnoField.classList.add('is-invalid');
            e.preventDefault();
            if (warningText) warningText.textContent = 'Por favor, seleccioná un turno válido.';
            if (warningDiv) {
                warningDiv.classList.remove('d-none');
                warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            // Quitar el error visual al seleccionar un turno
            turnoField.addEventListener('change', function handler2() {
                if (turnoHeader) turnoHeader.classList.remove('is-invalid');
                turnoField.classList.remove('is-invalid');
                turnoField.removeEventListener('change', handler2);
            });
            return;
        }
    });
});
// --- Autocomplete de legajos para ausencias (inline) ---
// Requiere: input con id="input_legajo" y endpoint /api/empleados/legajos/
function setupLegajoAutocomplete(inputId, onSelected) {
    const input = document.getElementById(inputId);
    if (!input) return;
    // No activar autocomplete si el campo está readonly o disabled (modo edición)
    if (input.readOnly || input.disabled) return;
    let timeout = null;
    let dropdown = null;
    let empleados = [];

    function closeDropdown() {
        if (dropdown) {
            dropdown.remove();
            dropdown = null;
        }
    }

    function renderDropdown(items, filterText) {
        closeDropdown();
        if (!items.length) return;
        dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        dropdown.style.position = 'absolute';
        dropdown.style.zIndex = 1000;
        dropdown.style.background = '#fff';
        dropdown.style.border = '1px solid #e0e5ec';
        dropdown.style.width = input.offsetWidth + 'px';
        dropdown.style.maxHeight = '220px';
        dropdown.style.overflowY = 'auto';
        dropdown.style.borderRadius = '8px';
        dropdown.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
        dropdown.style.top = (input.offsetTop + input.offsetHeight) + 'px';
        dropdown.style.left = input.offsetLeft + 'px';

        // Filtrar por legajo, nombre o especialidad (case-insensitive)
        let filtered = items;
        if (filterText && filterText.length > 0) {
            const q = filterText.toLowerCase();
            filtered = items.filter(emp =>
                (`${emp.legajo}`.toLowerCase().includes(q) ||
                 (emp.nombre && emp.nombre.toLowerCase().includes(q)) ||
                 (emp.especialidad && emp.especialidad.toLowerCase().includes(q)))
            );
        }
        if (!filtered.length) return;
        filtered.forEach(emp => {
            const option = document.createElement('div');
            option.className = 'autocomplete-option';
            option.textContent = `#${emp.legajo} - ${emp.nombre} (${emp.especialidad})`;
            option.style.padding = '0.5rem 1rem';
            option.style.cursor = 'pointer';
            option.onmousedown = e => {
                e.preventDefault();
                onSelected(emp);
                closeDropdown();
            };
            dropdown.appendChild(option);
        });
        input.parentNode.appendChild(dropdown);
    }

    input.addEventListener('input', function() {
        let q = input.value.trim();
        if (timeout) clearTimeout(timeout);
        // Si el usuario solo tipea '#' o deja vacío, mostrar todos los legajos
        let backendQ = '';
        if (q === '' || q === '#') {
            backendQ = '';
        } else if (q.startsWith('#')) {
            backendQ = q.slice(1);
        } else {
            backendQ = q;
        }
        timeout = setTimeout(() => {
            fetch(`/api/empleados/legajos/?q=${encodeURIComponent(backendQ)}`)
                .then(r => r.json())
                .then(data => {
                    empleados = data.empleados || [];
                    renderDropdown(empleados, q);
                })
                .catch(e => console.error('[autocomplete] fetch error', e));
        }, 200);
    });

    input.addEventListener('blur', function() {
        setTimeout(closeDropdown, 150);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Guardar la especialidad seleccionada en una variable global
    let especialidadSeleccionada = null;
    setupLegajoAutocomplete('input_legajo', function(emp) {
        document.getElementById('input_legajo').value = `#${emp.legajo} - ${emp.nombre} (${emp.especialidad})`;
        const $empleado = document.getElementById('id_empleado');
        $empleado.value = emp.id;
        especialidadSeleccionada = emp.especialidad_codigo || emp.especialidad; // prefer code if available
        filtrarTurnosPorEspecialidad(especialidadSeleccionada);
    });
    // --- Referencias ---
    const $empleado = document.getElementById('id_empleado');
    const $turno = document.getElementById('id_tipo_turno');

    // Inicializar custom dropdowns si existen wrappers
    document.querySelectorAll('.custom-select-wrapper').forEach(setupCustomDropdown);

    // Nueva función para filtrar turnos según especialidad
    function filtrarTurnosPorEspecialidad(esp) {
        const turnoWrapper = $turno.closest('.custom-select-wrapper');
        const turnoHeader = turnoWrapper ? turnoWrapper.querySelector('.custom-dropdown-header') : null;
        const turnoMenu = turnoWrapper ? turnoWrapper.querySelector('.custom-dropdown-menu') : null;

        // Filtrar opciones nativas de turno por especialidad
        for (let i = 0; i < $turno.options.length; i++) {
            const opt = $turno.options[i];
            // Siempre mostrar la opción 'Todo el día' (value vacía)
            if (!opt.value) {
                opt.style.display = '';
            } else if (esp && opt.getAttribute('data-especialidad') === esp) {
                opt.style.display = '';
            } else {
                opt.style.display = 'none';
            }
        }

        // Filtrar las opciones del menú personalizado
        if (turnoMenu){
            turnoMenu.querySelectorAll('.custom-option').forEach(opt => {
                const val = opt.getAttribute('data-value');
                const optEsp = opt.getAttribute('data-especialidad') || '';
                // Siempre mostrar la opción 'Todo el día' (value vacía)
                if (!val) {
                    opt.style.display = '';
                    return;
                }
                if (esp && optEsp === esp) opt.style.display = '';
                else opt.style.display = 'none';
            });
        }

        // Si la selección actual no es válida para la especialidad, resetear. Si es 'Todo el día', mantener.
        const selectedOpt = $turno.options[$turno.selectedIndex];
        if ($turno.value && $turno.value !== '' && selectedOpt && selectedOpt.getAttribute('data-especialidad') !== esp) {
            $turno.value = '';
        }

        // Activar o desactivar el control de turno
        setTurnoEnabled(!!esp);
    }

    // Habilitar/deshabilitar el campo turno
    function setTurnoEnabled(enabled){
        $turno.disabled = !enabled;
        const turnoWrapper = $turno.closest('.custom-select-wrapper');
        const turnoHeader = turnoWrapper ? turnoWrapper.querySelector('.custom-dropdown-header') : null;
        const turnoMenu = turnoWrapper ? turnoWrapper.querySelector('.custom-dropdown-menu') : null;
        if (turnoHeader){
            if (!enabled){
                turnoHeader.classList.add('disabled');
                turnoHeader.textContent = 'Seleccioná un empleado primero';
            } else {
                turnoHeader.classList.remove('disabled');
                // si ya hay un turno seleccionado, mostrar su texto, si no, mostrar placeholder
                const sel = $turno.options[$turno.selectedIndex];
                if (sel && $turno.value) turnoHeader.textContent = sel.textContent;
                else turnoHeader.textContent = 'Seleccioná un turno';
            }
        }
        if (turnoMenu && !enabled){
            turnoMenu.querySelectorAll('.custom-option').forEach(opt => {
                if (opt.getAttribute('data-value') === '') opt.style.display = '';
                else opt.style.display = 'none';
            });
        }
    }

    // Inicializar estado según si ya hay empleado seleccionado
    // Si el formulario llega con empleado, tomamos su especialidad del atributo data-especialidad
    const empleadoEspecialidadInicial = $empleado ? $empleado.getAttribute('data-especialidad') : null;
    if ($empleado && $empleado.value) {
        const esp = empleadoEspecialidadInicial || null;
        if (esp) {
            filtrarTurnosPorEspecialidad(esp);
        } else {
            // Si no conocemos la especialidad, habilitamos el turno por defecto
            setTurnoEnabled(true);
        }
    } else {
        setTurnoEnabled(false);
    }

    // Asegurarnos de que el header del dropdown muestre la opción seleccionada (si la hay)
    try {
        const turnoWrapperInit = $turno ? $turno.closest('.custom-select-wrapper') : null;
        const turnoHeaderInit = turnoWrapperInit ? turnoWrapperInit.querySelector('.custom-dropdown-header') : null;
        const selectedOption = $turno ? $turno.options[$turno.selectedIndex] : null;
        if (turnoHeaderInit) {
            if ($turno && $turno.value && selectedOption && selectedOption.style.display !== 'none') {
                turnoHeaderInit.textContent = selectedOption.textContent;
            } else if ($turno && $turno.value === '') {
                // Si no hay valor seleccionado, preferimos mostrar 'Todo el día' cuando exista
                const optTodo = Array.from($turno.options).find(o => !o.value);
                if (optTodo) turnoHeaderInit.textContent = optTodo.textContent || 'Todo el día';
                else turnoHeaderInit.textContent = 'Seleccioná un turno';
            }
        }
    } catch (e) { console.error('init turno header error', e); }

    // Helpers: configurar un wrapper de dropdown personalizado (replicar lógica de generador.html)
    function setupCustomDropdown(wrapper){
        const nativeSelect = wrapper.querySelector('.form-select');
        const header = wrapper.querySelector('.custom-dropdown-header');
        const dropdown = wrapper.querySelector('.custom-dropdown');
        const menu = wrapper.querySelector('.custom-dropdown-menu');
        if (!header || !dropdown || !menu || !nativeSelect) return;

        // Inicializar header con el valor seleccionado o placeholder
        try {
            const sel = nativeSelect.options[nativeSelect.selectedIndex];
            if (sel && sel.textContent && nativeSelect.value) {
                header.textContent = sel.textContent;
            }
        } catch (e) {}

        header.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            // don't open if native select is disabled
            if (nativeSelect.disabled) return;
            document.querySelectorAll('.custom-dropdown.open').forEach(d => { if(d !== dropdown) d.classList.remove('open'); });
            dropdown.classList.toggle('open');
        };

        menu.querySelectorAll('.custom-option').forEach((option, index) => {
            option.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                // ignore clicks when option hidden or select disabled
                if (nativeSelect.disabled) return;
                if (option.style.display === 'none') return;
                // Permitir seleccionar el placeholder ("Todo el día")
                const value = option.getAttribute('data-value');
                const text = option.textContent;
                nativeSelect.value = value;
                header.textContent = text;
                dropdown.classList.remove('open');
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            };
        });

        document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) dropdown.classList.remove('open'); });
    }
});
</script>
{% endblock %}

