{% extends "base.html" %}

{% block title %}Vista Diaria{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 no-print border-bottom pb-3">
    <div>
        <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Vista Diaria - {{ cronograma.get_especialidad_display }}</h1>
        <p class="text-muted fs-5 mb-0">{{ cronograma.fecha_inicio|date:"d/m/Y" }} al {{ cronograma.fecha_fin|date:"d/m/Y" }}</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <a href="{% url 'exportar_pdf' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-2">
            <i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF
        </a>
        <a href="{% url 'exportar_excel' cronograma.id %}" class="btn btn-outline-secondary fw-bold px-3 me-3">
            <i class="bi bi-file-earmark-excel-fill me-1"></i>Excel
        </a>

        <div>
            <form id="form-toggle-publicado" method="post" style="display:inline-block;">
                {% csrf_token %}
                <input type="hidden" name="silent" id="silent_toggle" value="1">
                <div class="form-check form-switch d-inline-flex align-items-center gap-2 switch-custom">
                    <input class="form-check-input" type="checkbox" id="togglePublicado" name="publicado" {% if cronograma.estado == 'PUBLICADO' %}checked{% endif %}>
                    <label class="form-check-label mb-0 fw-semibold" for="togglePublicado" style="color: #2f3e4c;">Publicado</label>
                </div>
            </form>
        </div>

        <!-- Publish/Unpublish confirmation modal (same style as other cronograma views) -->
        <div class="modal fade" id="publishConfirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                    <div class="modal-header border-0 pb-0 pt-4 px-4" style="background: white;">
                        <button type="button" class="btn-close position-absolute" style="top: 16px; right: 16px; opacity: 0.5;" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center px-5 pb-4 pt-2">
                        <div class="mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0d6efd;">
                                <i class="bi bi-exclamation-lg" style="font-size: 2rem; color: #0d6efd;"></i>
                            </div>
                        </div>

                        <h4 class="fw-bold mb-3" style="color: #2f3e4c;">¿Estás seguro?</h4>

                        <div class="mb-3 p-4 text-center" style="background-color: #ffffff; border-radius: 10px; border: 1px solid #e0e5ec; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
                            <p id="publishModalText" class="mb-2 fw-bold" style="color:#2f3e4c;">Estas a punto de publicar/despublicar (según corresponda) este cronograma oficialmente</p>
                            <p id="publishModalNote" class="mb-0 small" style="color:#6c757d;">La nueva regla se aplicará y la anterior se sobreescribirá.</p>
                        </div>
                    </div>
                    <div class="modal-footer border-0 bg-white justify-content-center gap-2 pb-4">
                        <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="border-radius: 10px; font-weight: 600; border: 1px solid #dee2e6; min-width: 140px;">Cancelar</button>
                        <button type="button" id="confirmPublishBtn" class="btn btn-primary px-4 py-2" style="border-radius: 10px; font-weight: 600; min-width: 140px;">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    {% for fecha, turnos in agenda.items %}
        <div class="card mb-4 page-break-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center print-header">
                <div>
                    <h5 class="mb-0 text-capitalize" style="color:#2f3e4c; font-weight:700;">{{ fecha|date:"l d \\d\\e F Y" }}</h5>
                </div>
            </div>

            <div class="card-body">
                <div class="row g-3"> {% for nombre_turno, empleados in turnos.items %}
                        <div class="col-md-4 print-col-4">
                            <div class="card h-100 turno-card">
                                <div class="card-header bg-white border-bottom-0 pt-3 pb-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title text-primary fw-bold mb-0">{{ nombre_turno }}</h6>
                                        <span class="badge bg-secondary rounded-pill">{{ empleados|length }}</span>
                                    </div>
                                </div>

                                <div class="card-body p-2">
                                    <ul class="list-group list-group-flush rounded-2">
                                        {% for emp in empleados %}
                                            <li class="list-group-item bg-white py-1 px-2 d-flex justify-content-between align-items-center mb-1 rounded-1 shadow-sm small-text">
                                                <span class="fw-medium text-dark">{{ emp.nombre_completo }}</span>
                                                {% if emp.experiencia == 'SENIOR' %}
                                                    <span class="badge rounded-pill exp-badge ms-2" title="Senior">S</span>
                                                {% elif emp.experiencia == 'JUNIOR' %}
                                                    <span class="badge rounded-pill exp-badge ms-2" title="Junior">J</span>
                                                {% endif %}
                                            </li>
                                        {% empty %}
                                            <li class="list-group-item bg-transparent text-muted small fst-italic text-center">
                                                Sin asignaciones
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<style>
    /* Estilos normales de pantalla */
    :root{ --accent-blue: #0d6efd; }
    .small-text { font-size: 0.9rem; }

    /* Harmonize with cronograma_detail styles */
    .titulo-principal { color: #2f3e4c; }
    .turno-card { background-color: #f8f9fa; border-radius: 12px; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.04); }
    .card-header .card-title { color: var(--accent-blue); }

    /* Remove outer card divider/shadow under the day header */
    .page-break-card {
        border: none;
        box-shadow: none;
    }
    .page-break-card > .card-header {
        border-bottom: none !important;
        padding-bottom: 0.6rem;
    }

    /* Fix card header rendering so top corners aren't visually cut */
    .turno-card {
        overflow: visible;
    }
    .turno-card .card-header {
        background: transparent !important;
        border-bottom: none !important;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        padding-top: 0.75rem;
        padding-bottom: 0.5rem;
    }
    .turno-card .card-body {
        padding-top: 0.5rem;
    }

    /* Experience badges: white background for both Senior and Junior */
    .exp-badge {
        background: #ffffff !important;
        color: #2f3e4c !important;
        border: 1px solid #dee2e6 !important;
        padding: 0.15rem 0.45rem !important;
        font-size: 0.75rem !important;
        font-weight: 600 !important;
    }

    /* Match switch sizing used in cronograma_detail (3.5em x 1.75em) */
    .switch-custom .form-check-input {
        width: 3.5em;
        height: 1.75em;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
    .switch-custom .form-check-input:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
    .switch-custom .form-check-label {
        cursor: pointer;
        user-select: none;
        font-size: 1.05rem;
        color: #2f3e4c;
        font-weight: 700;
    }

    /* ESTILOS DE IMPRESIÓN */
    @media print {
        /* Configuración de Página */
        @page {
            size: landscape; /* Horizontal para que entren los 3 turnos lado a lado */
            margin: 8mm;
        }

        /* Ocultar interfaz */
        header, footer, nav, .sidebar, .no-print, .btn, .navbar {
            display: none !important;
        }

        /* Ajustes de Cuerpo */
        body {
            background-color: white !important;
            font-family: sans-serif;
            -webkit-print-color-adjust: exact !important; /* Imprimir colores de fondo */
            print-color-adjust: exact !important;
            font-size: 10pt; /* Letra un poco más chica para ahorrar papel */
        }

        .container, .container-fluid {
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* EVITAR CORTES DE PÁGINA FEOS */
        .page-break-card {
            break-inside: avoid !important;
            page-break-inside: avoid !important;
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 15px !important;
        }

        /* Header de tarjeta más simple para imprimir */
        .print-header {
            background-color: #333 !important; /* Forzar negro/gris oscuro */
            color: white !important;
            border-bottom: 1px solid black;
        }

        /* FORZAR GRID DE 3 COLUMNAS */
        /* Bootstrap a veces colapsa a 1 columna al imprimir, esto lo evita */
        .row {
            display: flex !important;
            flex-wrap: wrap !important;
        }
        
        .print-col-4 {
            width: 33.33% !important;
            flex: 0 0 33.33% !important;
            max-width: 33.33% !important;
            padding-right: 5px; /* Espacio entre columnas */
        }

        /* Limpieza visual de las tarjetas internas */
        .turno-card {
            border: none !important;
            background-color: #f8f9fa !important;
        }
        
        /* Badges más legibles en papel */
        .badge {
            border: 1px solid #000 !important;
            color: black !important;
            background: white !important; /* Ahorrar tinta en badges grandes */
        }
        .badge.bg-warning {
            background: #ffc107 !important; /* Mantener amarillo para Senior */
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    var toggle = document.getElementById('togglePublicado');
    var form = document.getElementById('form-toggle-publicado');
    var publishModalEl = document.getElementById('publishConfirmModal');
    var publishModal = publishModalEl ? new bootstrap.Modal(publishModalEl) : null;
    var publishText = document.getElementById('publishModalText');
    var confirmPublishBtn = document.getElementById('confirmPublishBtn');

    if(!toggle || !form) return;

    var previousChecked = toggle.checked;

    toggle.addEventListener('change', function(e){
        var willPublish = this.checked;
        if (publishText) {
            publishText.textContent = willPublish
                ? 'Estas a punto de publicar este cronograma oficialmente'
                : 'Estas a punto de despublicar este cronograma oficialmente';
        }
        if (confirmPublishBtn) {
            confirmPublishBtn.textContent = willPublish ? 'Publicar' : 'Continuar';
            confirmPublishBtn.classList.remove('btn-danger');
            confirmPublishBtn.classList.add('btn-primary');
        }

        if (publishModal) {
            e.preventDefault();
            publishModal.show();
        } else {
            submitPublish(willPublish);
        }
    });

    function submitPublish(willPublish){
        var action = willPublish
            ? "{% url 'cronograma_publish' cronograma.id %}"
            : "{% url 'cronograma_unpublish' cronograma.id %}";

        var fd = new FormData(form);

        fetch(action, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(function(resp){
            if (resp.ok) {
                previousChecked = toggle.checked;
            } else {
                toggle.checked = previousChecked;
                alert('No se pudo completar la acción. Intenta nuevamente.');
            }
        }).catch(function(){
            toggle.checked = previousChecked;
            alert('Error de red al intentar publicar/despublicar.');
        });
    }

    if (confirmPublishBtn) {
        confirmPublishBtn.addEventListener('click', function(){
            var desired = toggle.checked;
            if (publishModal) publishModal.hide();
            submitPublish(desired);
        });

        if (publishModalEl) {
            publishModalEl.addEventListener('hidden.bs.modal', function(){
                if (toggle.checked === previousChecked) return;
                toggle.checked = previousChecked;
            });
        }
    }
});
</script>

{% endblock %}