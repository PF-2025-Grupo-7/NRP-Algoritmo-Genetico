{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Encabezado -->
            <div class="row mb-4 align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 fw-bold mb-1" style="color: #2f3e4c;">Configuración Avanzada</h1>
                    <p class="text-muted fs-5 mb-0">Parámetros del algoritmo</p>
                </div>
            </div>

            <!-- Alert de éxito -->
            <div id="success-alert" class="alert alert-success alert-dismissible fade show mb-4" role="alert" style="display: none;">
                <strong>¡Cambios guardados!</strong> Tu configuración personalizada ha sido guardada correctamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <form method="post" id="form-config-avanzada" novalidate>
                {% csrf_token %}
                <div class="card-body p-4">
                    {% if form.non_field_errors %}
                        <div id="server-errors" class="field-error mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span>{{ form.non_field_errors|join:", " }}</span>
                        </div>
                    {% endif %}
                
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom-0">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active fw-bold" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech" type="button">
                                    Parámetros Técnicos
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link fw-bold" id="biz-tab" data-bs-toggle="tab" data-bs-target="#biz" type="button">
                                    Pesos de Negocio
                                </button>
                            </li>
                        </ul>
                    </div>
                                
                    <div class="card-body p-4">
                        <div class="col-12">
                            <div id="form-warning" class="field-error d-none">
                                <i class="bi bi-exclamation-circle"></i>
                                <span id="form-warning-text"></span>
                            </div>
                        </div>
                        <div class="tab-content" id="myTabContent">
                            
                            <div class="tab-pane fade show active" id="tech">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Nombre Configuración<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.nombre }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Semilla (Opcional)</label>
                                        {{ form.semilla }}
                                    </div>
                                </div>
                                <hr>
                                <h6 class="text-primary mb-3">Algoritmo Genético</h6>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Población<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.tamano_poblacion }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Generaciones<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.generaciones }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Prob. Cruce<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.prob_cruce }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Prob. Mutación<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.prob_mutacion }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Selección<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        <div class="custom-select-wrapper">
                                            <select class="form-select d-none" id="{{ form.estrategia_seleccion.id_for_label }}" name="{{ form.estrategia_seleccion.html_name }}" required>
                                                {% for value,label in form.estrategia_seleccion.field.choices %}
                                                    <option value="{{ value }}" {% if form.estrategia_seleccion.value == value %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="custom-dropdown">
                                                <div class="custom-dropdown-header" tabindex="0">
                                                    {% if form.estrategia_seleccion.value %}
                                                        {% for v,l in form.estrategia_seleccion.field.choices %}
                                                            {% if v == form.estrategia_seleccion.value %}{{ l }}{% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Seleccioná una opción
                                                    {% endif %}
                                                </div>
                                                <div class="custom-dropdown-menu">
                                                    {% for v,l in form.estrategia_seleccion.field.choices %}
                                                        <div class="custom-option" data-value="{{ v }}">{{ l }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Cruce<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        <div class="custom-select-wrapper">
                                            <select class="form-select d-none" id="{{ form.estrategia_cruce.id_for_label }}" name="{{ form.estrategia_cruce.html_name }}" required>
                                                {% for value,label in form.estrategia_cruce.field.choices %}
                                                    <option value="{{ value }}" {% if form.estrategia_cruce.value == value %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="custom-dropdown">
                                                <div class="custom-dropdown-header" tabindex="0">
                                                    {% if form.estrategia_cruce.value %}
                                                        {% for v,l in form.estrategia_cruce.field.choices %}
                                                            {% if v == form.estrategia_cruce.value %}{{ l }}{% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Seleccioná una opción
                                                    {% endif %}
                                                </div>
                                                <div class="custom-dropdown-menu">
                                                    {% for v,l in form.estrategia_cruce.field.choices %}
                                                        <div class="custom-option" data-value="{{ v }}">{{ l }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Mutación<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        <div class="custom-select-wrapper">
                                            <select class="form-select d-none" id="{{ form.estrategia_mutacion.id_for_label }}" name="{{ form.estrategia_mutacion.html_name }}" required>
                                                {% for value,label in form.estrategia_mutacion.field.choices %}
                                                    <option value="{{ value }}" {% if form.estrategia_mutacion.value == value %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="custom-dropdown">
                                                <div class="custom-dropdown-header" tabindex="0">
                                                    {% if form.estrategia_mutacion.value %}
                                                        {% for v,l in form.estrategia_mutacion.field.choices %}
                                                            {% if v == form.estrategia_mutacion.value %}{{ l }}{% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Seleccioná una opción
                                                    {% endif %}
                                                </div>
                                                <div class="custom-dropdown-menu">
                                                    {% for v,l in form.estrategia_mutacion.field.choices %}
                                                        <div class="custom-option" data-value="{{ v }}">{{ l }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check mt-2">
                                    {{ form.elitismo }}
                                    <label class="form-check-label" for="{{ form.elitismo.id_for_label }}">Activar Elitismo</label>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="biz">
                                <h6 class="text-primary mb-1">Ponderación de Objetivos (Pesos)</h6>
                                <p class="text-muted small mb-3">Cuanto mayor es el número, más importancia le dará el algoritmo a esa regla.</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Peso Equidad General</label>
                                        {{ form.peso_equidad_general }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Peso Turnos Difíciles</label>
                                        {{ form.peso_equidad_dificil }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Peso Días Libres (Preferencias)</label>
                                        {{ form.peso_preferencia_dias_libres }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Peso Turno Específico (Preferencias)</label>
                                        {{ form.peso_preferencia_turno }}
                                    </div>
                                </div>
                                <hr>
                                <h6 class="text-primary mb-3">Tolerancias y Factores</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Tolerancia Gral (Horas)<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.tolerancia_general }}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Tolerancia Difícil (Horas)<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.tolerancia_dificil }}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Factor Alpha (PTE)<span class="required-asterisk" aria-hidden="true">*</span></label>
                                        {{ form.factor_alpha_pte }}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div class="card-footer bg-white border-0 text-end p-4">
                        <a href="{% url 'config_dashboard' %}" class="btn btn-outline-secondary me-2 fw-bold">Cancelar</a>
                        <button type="submit" class="btn btn-primary fw-bold px-4">Guardar Configuración</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Estilos personalizados para las pestañas */
    
    /* 1. Estado Inactivo: Texto gris */
    .card-header-tabs .nav-link {
        color: #6c757d; 
        border: none;
        transition: all 0.3s ease;
    }
    
    /* 2. Al pasar el mouse (Hover): Texto azul primario */
    .card-header-tabs .nav-link:hover {
        color: #0d6efd;
        border: none;
    }
    
    /* 3. Estado Activo: Texto azul primario y borde inferior */
    .card-header-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-bottom: 2px solid #0d6efd;
    }
    /* Custom select styles (match other forms) */
    .form-control, .form-select {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: #ffffff;
        color: #2f3e4c;
    }

    .required-asterisk {
        color: #dc3545;
        margin-left: 0.25rem;
        font-weight: 700;
    }
    .form-select.d-none { display: none !important; }
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        background-color: #f8fbff;
        outline: none;
    }
    .custom-select-wrapper { position: relative; display: inline-block; width: 100%; }
    .custom-dropdown { position: relative; pointer-events: auto; }
    .custom-dropdown-header {
        height: 46px; box-sizing: border-box; border-radius: 8px; border: 1px solid #e0e5ec; background-color: #ffffff;
        padding: 0.75rem 1rem; font-size: 0.95rem; line-height: 1; color: #495057; display: inline-flex; align-items: center; width: 100%;
        transition: all 0.2s ease; cursor: pointer;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; pointer-events: auto;
    }
    .custom-dropdown-header.disabled{ opacity:0.6; cursor:not-allowed; pointer-events:none; }
    .custom-dropdown-menu {
        position: absolute; top: 100%; left: 0; right: 0; background-color: #ffffff; border: none;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12); border-radius: 10px; max-height: 0; overflow: hidden;
        transition: max-height 0.3s ease; pointer-events: none; z-index: 100; margin-top: 0; padding: 0;
    }
    .custom-dropdown.open .custom-dropdown-menu { max-height: 300px; pointer-events: auto; opacity: 1; margin-top: 0.5rem; padding: 0.5rem 0; }
    .custom-option { padding: 0.5rem 1.2rem; color: #495057; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; border-bottom: none; font-weight: 500; }
    .custom-option:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; padding-left: 1.4rem; }
    /* Warning / error banner inside card */
    .field-error {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 1rem;
        color: #c41c3b;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .field-error i {
        font-size: 1rem;
    }
</style>

<script>
// Custom dropdown helper (shared behavior with other forms)
function setupCustomDropdown(wrapper){
    const nativeSelect = wrapper.querySelector('.form-select');
    const header = wrapper.querySelector('.custom-dropdown-header');
    const dropdown = wrapper.querySelector('.custom-dropdown');
    const menu = wrapper.querySelector('.custom-dropdown-menu');
    if (!header || !dropdown || !menu || !nativeSelect) return;

    try {
        const sel = nativeSelect.options[nativeSelect.selectedIndex];
        if (sel && sel.textContent && nativeSelect.value) header.textContent = sel.textContent;
    } catch(e){}

    header.onclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        if (nativeSelect.disabled) return;
        const isOpen = dropdown.classList.contains('open');
        if (!isOpen) { if (window.closeAllDropdowns) window.closeAllDropdowns(dropdown); dropdown.classList.add('open'); } else { dropdown.classList.remove('open'); }
    };

    menu.querySelectorAll('.custom-option').forEach((option) => {
        option.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            if (nativeSelect.disabled) return;
            if (option.style.display === 'none') return;
            const value = option.getAttribute('data-value');
            const text = option.textContent;
            nativeSelect.value = value;
            header.textContent = text;
            dropdown.classList.remove('open');
            nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        };
    });

    document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) dropdown.classList.remove('open'); });
}

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form-config-avanzada');
        const serverErrors = document.getElementById('server-errors');

        // Inicializar custom dropdowns
        document.querySelectorAll('.custom-select-wrapper').forEach(setupCustomDropdown);

        // Prevenir números inválidos en inputs numéricos relevantes
        const numericInputs = form.querySelectorAll('input[type="number"]');
        numericInputs.forEach(input => {
            if (!input.hasAttribute('min')) input.setAttribute('min', '0');
            if (!input.hasAttribute('step')) input.setAttribute('step', '1');

            input.addEventListener('keydown', function(e) {
                if (e.key === '-' || e.key === 'e' || e.key === 'E') e.preventDefault();
            });

            input.addEventListener('input', function() {
                const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : null;
                const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : null;
                let v = input.value;
                if (v === '') return;
                v = String(v).replace(',', '.');
                let num = Number(v);
                if (isNaN(num)) { input.value = ''; return; }
                if (min !== null && num < min) input.value = min;
                if (max !== null && num > max) input.value = max;
            });

            input.addEventListener('wheel', function(e){ e.preventDefault(); });
        });

        form.addEventListener('submit', function(e) {
            const warningDiv = document.getElementById('form-warning');
            const warningText = document.getElementById('form-warning-text');
            if (warningDiv) warningDiv.classList.add('d-none');
            if (serverErrors) serverErrors.classList.add('d-none');

            // Helper to locate a field robustly (handles possible Django prefixes)
            function findField(name) {
                let el = form.querySelector('[name="' + name + '"]') || form.querySelector('#id_' + name) || form.querySelector('[name$="' + name + '"]');
                // If still not found, try inputs/selects with matching id or data-name
                if (!el) {
                    el = form.querySelector('[data-name="' + name + '"]') || document.getElementById('id_' + name);
                }
                return el;
            }

            const requiredFields = [
                { field: findField('nombre'), name: 'Nombre configuración' },
                { field: findField('tamano_poblacion'), name: 'Población' },
                { field: findField('generaciones'), name: 'Generaciones' },
                { field: findField('prob_cruce'), name: 'Prob. Cruce' },
                { field: findField('prob_mutacion'), name: 'Prob. Mutación' },
                { field: findField('estrategia_seleccion'), name: 'Selección' },
                { field: findField('estrategia_cruce'), name: 'Cruce' },
                { field: findField('estrategia_mutacion'), name: 'Mutación' },
                { field: findField('tolerancia_general'), name: 'Tolerancia Gral' },
                { field: findField('tolerancia_dificil'), name: 'Tolerancia Difícil' },
                { field: findField('factor_alpha_pte'), name: 'Factor Alpha' },
                { field: findField('peso_equidad_general'), name: 'Peso Equidad General' },
                { field: findField('peso_equidad_dificil'), name: 'Peso Turnos Difíciles' },
                { field: findField('peso_preferencia_dias_libres'), name: 'Peso Días Libres' },
                { field: findField('peso_preferencia_turno'), name: 'Peso Turno Específico' }
            ];

            // Determine empty fields (handles selects, numbers, and custom dropdowns)
            const emptyFields = requiredFields.filter(item => {
                const f = item.field;
                if (!f) return true;
                // For select elements, check selectedIndex/value
                if (f.tagName === 'SELECT') return !f.value || String(f.value).trim() === '';
                // For inputs, consider empty string
                if (f.tagName === 'INPUT' || f.tagName === 'TEXTAREA') return !f.value || String(f.value).trim() === '';
                // For other elements (custom dropdown header), try to read aria/value/text
                if (f.getAttribute && (f.getAttribute('data-value') !== null || f.getAttribute('aria-selected') !== null)) {
                    return !f.getAttribute('data-value') && !f.textContent.trim();
                }
                return !f.value || String(f.value).trim() === '';
            });
            // Debugging output to help identify why fields are not detected as empty
            try {
                console.groupCollapsed('config_avanzada validation debug');
                requiredFields.forEach(item => {
                    const f = item.field;
                    let val = null;
                    try { val = f ? (f.value !== undefined ? f.value : f.textContent) : null; } catch(e){ val = null; }
                    console.log(item.name, { found: !!f, tag: f && f.tagName, value: val });
                });
                console.log('emptyFields:', emptyFields.map(i => i.name));
                console.groupEnd();
            } catch(e) { console.log('validation debug error', e); }

            if (emptyFields.length > 0) {
                e.preventDefault();
                warningText.textContent = 'Por favor, completá todos los campos obligatorios (*)';
                warningDiv.classList.remove('d-none');
                warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Marcar los campos vacíos como inválidos visualmente
                emptyFields.forEach(function(item) {
                    item.field.classList.add('is-invalid');
                    item.field.addEventListener('input', function handler() {
                        item.field.classList.remove('is-invalid');
                        item.field.removeEventListener('input', handler);
                    });
                    // Si el campo es un select personalizado, marcar el header también
                    if (item.field.classList.contains('form-select')) {
                        var wrapper = item.field.closest('.custom-select-wrapper');
                        if (wrapper) {
                            var header = wrapper.querySelector('.custom-dropdown-header');
                            if (header) {
                                header.classList.add('is-invalid');
                                item.field.addEventListener('change', function handler2() {
                                    header.classList.remove('is-invalid');
                                    item.field.removeEventListener('change', handler2);
                                });
                            }
                        }
                    }
                });
                return;
            }

            let invalidRange = false;
            numericInputs.forEach(input => {
                const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : null;
                const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : null;
                if (!input.value) return;
                const v = Number(String(input.value).replace(',', '.'));
                if ((min !== null && v < min) || (max !== null && v > max)) {
                    invalidRange = true;
                    input.classList.add('is-invalid');
                }
            });
            if (invalidRange) {
                e.preventDefault();
                if (warningText) warningText.textContent = 'Hay valores numéricos fuera de los rangos permitidos.';
                if (warningDiv) { warningDiv.classList.remove('d-none'); warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                return;
            }

            // Si llegamos acá, la validación cliente pasó. Enviamos por AJAX y redirigimos al dashboard al guardar correctamente.
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.dataset.origHtml = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando...';
            }

            const action = form.getAttribute('action') || window.location.href;
            const formData = new FormData(form);

            fetch(action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(response => {
                // Si el servidor redirige, seguimos la redirección
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                if (response.ok) {
                    // Asumimos guardado correcto -> ir al dashboard
                    window.location.href = "{% url 'config_dashboard' %}";
                    return;
                }
                return response.text().then(text => {
                    // Mostrar errores del servidor (render HTML parcial o mensaje)
                    if (serverErrors) {
                        serverErrors.innerHTML = text;
                        serverErrors.classList.remove('d-none');
                        serverErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = submitBtn.dataset.origHtml || 'Guardar Configuración';
                    }
                });
            }).catch(err => {
                if (warningText) {
                    warningText.textContent = 'Error guardando la configuración. Intentá nuevamente.';
                    warningDiv.classList.remove('d-none');
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = submitBtn.dataset.origHtml || 'Guardar Configuración';
                }
            });
        });
    });
</script>
{% endblock %}